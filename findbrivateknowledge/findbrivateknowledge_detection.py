import io
from math import sqrt

import cv2
import numpy as np
import pywt
from scipy.linalg import svd
from scipy.signal import convolve2d

BLOCK_SIZE = 64
LOW_THRESHOLD = 100
HIGH_THRESHOLD = 150
ALPHA = 5.0
THRESHOLD = 0.81


def wpsnr(img1, img2):
    img1 = np.float32(img1) / 255.0
    img2 = np.float32(img2) / 255.0
    difference = img1 - img2
    same = not np.any(difference)
    if same is True:
        return 9999999
    w = np.genfromtxt('csf.csv', delimiter=',')
    ew = convolve2d(difference, np.rot90(w, 2), mode='valid')
    decibels = 20.0 * np.log10(1.0 / sqrt(np.mean(np.mean(ew ** 2))))
    return decibels


def similarity(X, X_star):
    norm_X = np.sqrt(np.sum(np.multiply(X, X)))
    norm_X_star = np.sqrt(np.sum(np.multiply(X_star, X_star)))

    if norm_X == 0 or norm_X_star == 0:
        return 0.0

    s = np.sum(np.multiply(X, X_star)) / (norm_X * norm_X_star)
    return s

def select_best_regions(edge_map):
    h, w = edge_map.shape
    regions = []

    for i in range(1, h - BLOCK_SIZE + 1, 8):
        for j in range(1, w - BLOCK_SIZE + 1, 8):
            block = edge_map[i:i + BLOCK_SIZE, j:j + BLOCK_SIZE]
            edge_density = np.mean(block)

            regions.append((i, j, edge_density))

    regions = sorted(regions, key=lambda x: x[2], reverse=True)

    selected_regions = []
    selected_regions.append(regions[0])
    selected_regions.append(regions[len(regions) - 1])
    selected_regions.append(regions[int(len(regions) // 2)])

    return [(i, j) for i, j, _ in selected_regions]


def extraction(image_wm, original):
    edges = cv2.Canny(original, LOW_THRESHOLD, HIGH_THRESHOLD)
    regions = select_best_regions(edges)

    watermarks = []
    for region in regions:
        x, y = region
        block_wm = image_wm[x:x + BLOCK_SIZE, y:y + BLOCK_SIZE]

        LL_w, (LH_w, HL_w, HH_w) = pywt.dwt2(block_wm, 'haar')
        U_w, S_w, V_w = svd(LL_w)

        LL, (LH, HL, HH) = pywt.dwt2(original[x:x + BLOCK_SIZE, y:y + BLOCK_SIZE], 'haar')
        U, S, V = svd(LL)

        S_extracted = np.zeros(32)
        for i in range(32):
            S_extracted[i] = abs(S_w[i] - S[i]) / ALPHA

        U_wm_txt = """-2.085144519805908203e-01 1.980909587473433930e-07 3.826757222213927889e-08 3.601653730811449350e-08 -1.800826865405724675e-08 -4.502067163514311687e-09 -6.753100745271467531e-09 -1.463171805937690806e-08 0.000000000000000000e+00 -3.038895357576620881e-08 -1.688275119704485405e-08 0.000000000000000000e+00 -1.969654439548662594e-09 -2.363585238640553143e-08 -2.363585238640553143e-08 -2.363585238640553143e-08 -1.125516746469656937e-08 -5.402480596217174025e-08 -1.350620149054293506e-08 0.000000000000000000e+00 1.294344276203673871e-08 1.800826865405724675e-08 -2.701240298108587012e-08 2.701240298108587012e-08 -9.004134327028623375e-09 -1.800826865405724675e-08 0.000000000000000000e+00 5.366882280724420175e-16 -5.735988573007944069e-09 1.985099196133432997e-09 4.100987549549017785e-09 9.780192971229553223e-01
0.000000000000000000e+00 2.086162567138671875e-07 -9.618026614189147949e-01 2.732917666435241699e-03 -4.093220457434654236e-02 -2.164092659950256348e-02 -1.811904460191726685e-02 -1.811903156340122223e-02 0.000000000000000000e+00 -3.962775319814682007e-02 -2.698007225990295410e-02 0.000000000000000000e+00 -6.189657375216484070e-03 -2.840008027851581573e-02 -2.840008027851581573e-02 -2.840008027851581573e-02 -1.511612720787525177e-02 -2.555235922336578369e-01 2.050644345581531525e-02 0.000000000000000000e+00 3.781596571207046509e-02 5.292871918527453090e-09 5.390582202835503267e-08 3.181864727253014280e-08 -7.347374264554673573e-09 6.683609221624919883e-09 8.397806006144037383e-09 -4.708859971089588651e-17 1.063733434669700273e-09 2.302465773595940846e-09 4.857025892590627336e-09 0.000000000000000000e+00
-2.085143923759460449e-01 -2.562354207038879395e-01 -2.467171498210518621e-07 4.488831758499145508e-01 3.237693905830383301e-01 5.078942179679870605e-01 -4.482622817158699036e-02 -4.482622817158699036e-02 0.000000000000000000e+00 -2.911517322063446045e-01 -1.099297031760215759e-01 0.000000000000000000e+00 -2.521961927413940430e-02 -1.157154664397239685e-01 -1.157154664397239685e-01 -1.157154664397239685e-01 3.242042064666748047e-01 -3.259610384702682495e-04 -2.240397483110427856e-01 0.000000000000000000e+00 1.662180572748184204e-01 -1.565417484528097702e-08 -1.927743831231509830e-08 1.720657216708332271e-08 -2.043436531096176623e-09 1.015192552245025581e-08 5.411056047677220704e-09 -1.350236295325664957e-16 -1.206891742100424381e-08 -5.559775750896278623e-09 -8.539291052045427932e-09 -4.445540904998779297e-02
0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 3.874301910400390625e-07 -7.827672362327575684e-01 4.577084779739379883e-01 4.692731052637100220e-02 4.692732170224189758e-02 0.000000000000000000e+00 -4.629670828580856323e-02 3.657502681016921997e-02 0.000000000000000000e+00 8.390882983803749084e-03 3.850001841783523560e-02 3.850001841783523560e-02 3.850001841783523560e-02 2.547497153282165527e-01 9.005741029977798462e-02 2.942344546318054199e-01 0.000000000000000000e+00 7.611844688653945923e-02 -2.787056807562748872e-09 6.139840280638964032e-08 3.973528706069373584e-08 -2.469572990548840608e-08 2.371344187679369497e-08 6.955748865777877654e-09 4.249956843206317966e-16 3.521540392625865934e-09 3.631216216604116198e-09 3.469947662537720134e-10 0.000000000000000000e+00
0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 -4.172325134277343750e-07 5.956965088844299316e-01 -3.082908317446708679e-02 -3.082907572388648987e-02 0.000000000000000000e+00 3.138656020164489746e-01 3.935341536998748779e-02 0.000000000000000000e+00 9.028304368257522583e-03 4.142467305064201355e-02 4.142467305064201355e-02 4.142467305064201355e-02 -6.362096071243286133e-01 -1.307433247566223145e-01 -2.339054197072982788e-01 0.000000000000000000e+00 -2.477633506059646606e-01 5.349163600953943387e-08 2.101145568644824380e-08 1.028695795213252495e-08 -2.701855628117755259e-09 4.040673573513231531e-09 8.549417285230731522e-10 -3.128814240402073409e-16 -4.428637012665603834e-09 -8.540498974696220102e-09 2.254994857509018402e-09 0.000000000000000000e+00
-2.085143923759460449e-01 -2.562353909015655518e-01 -8.280436247787292814e-08 -5.611039325594902039e-02 -4.047125205397605896e-02 -6.571281701326370239e-02 -2.457384616136550903e-01 -2.457384467124938965e-01 0.000000000000000000e+00 7.873307466506958008e-01 -6.968600302934646606e-02 0.000000000000000000e+00 -1.598703116178512573e-02 -7.335366308689117432e-02 -7.335366308689117432e-02 -7.335367053747177124e-02 3.009927868843078613e-01 -4.323624446988105774e-02 -5.163707211613655090e-02 0.000000000000000000e+00 1.507766991853713989e-01 -2.446694047364417202e-08 -3.374287071977732921e-09 2.508862273487011407e-08 8.658217254264855001e-09 -1.225280321648369863e-09 7.035896754103987405e-09 1.515574876698438239e-16 7.202816121321120590e-09 6.666467822213917316e-09 -1.229281343384514003e-09 -4.445540904998779297e-02
-2.085143923759460449e-01 -2.562353909015655518e-01 -8.280436247787292814e-08 -5.611039325594902039e-02 -4.047119244933128357e-02 -6.316877156496047974e-02 -2.088700234889984131e-01 -2.088700234889984131e-01 0.000000000000000000e+00 -1.799747496843338013e-01 -2.491136193275451660e-01 0.000000000000000000e+00 -5.715059116482734680e-02 -2.622248530387878418e-01 -2.622248530387878418e-01 -2.622248530387878418e-01 -1.671749800443649292e-01 1.477953195571899414e-01 4.005039632320404053e-01 0.000000000000000000e+00 -5.278865098953247070e-01 7.059448847712701536e-08 8.523343808519712184e-09 -3.089656530619322439e-08 1.322295606343004692e-08 -4.801748332283750642e-09 -8.754495794960348576e-09 8.095480997436023157e-17 3.269752024692706982e-09 1.082863465562411420e-09 6.193113577523945423e-09 -4.445540904998779297e-02
-2.085143923759460449e-01 -2.562353909015655518e-01 -8.280436247787292814e-08 -5.611039325594902039e-02 -4.047119244933128357e-02 -6.316878646612167358e-02 9.165724515914916992e-01 -8.342754840850830078e-02 0.000000000000000000e+00 9.637049585580825806e-02 -6.187844648957252502e-02 0.000000000000000000e+00 -1.419588550925254822e-02 -6.513520330190658569e-02 -6.513520330190658569e-02 -6.513520330190658569e-02 -2.370542287826538086e-02 -4.368797317147254944e-02 -4.712031409144401550e-02 0.000000000000000000e+00 -4.806921258568763733e-02 1.098985080716374796e-08 -3.327504938255287925e-09 5.644900991086387876e-09 3.581777319183743202e-09 -2.611149074738250420e-09 1.124794257734151870e-09 -2.054731199960501678e-17 -1.486956002771933072e-09 -4.434504707884201480e-10 5.230127997357669756e-10 -4.445540904998779297e-02
-2.085143923759460449e-01 -2.562353909015655518e-01 -8.280436247787292814e-08 -5.611039325594902039e-02 -4.047119244933128357e-02 -6.316878646612167358e-02 -8.342754840850830078e-02 9.165724515914916992e-01 0.000000000000000000e+00 9.637049585580825806e-02 -6.187844648957252502e-02 0.000000000000000000e+00 -1.419588550925254822e-02 -6.513520330190658569e-02 -6.513520330190658569e-02 -6.513520330190658569e-02 -2.370542287826538086e-02 -4.368797317147254944e-02 -4.712031409144401550e-02 0.000000000000000000e+00 -4.806921258568763733e-02 1.098985080716374796e-08 -3.327504938255287925e-09 5.644900991086387876e-09 3.581777319183743202e-09 -2.611149074738250420e-09 1.124794257734151870e-09 -2.054731199960501678e-17 -1.486956002771933072e-09 -4.434504707884201480e-10 5.230127997357669756e-10 -4.445540904998779297e-02
0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 1.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00
0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 -2.236067950725555420e-01 0.000000000000000000e+00 9.746794104576110840e-01 -3.352761268615722656e-08 -3.352761268615722656e-08 -1.862645149230957031e-08 -6.705522537231445312e-08 1.862645149230957031e-08 3.352761268615722656e-08 0.000000000000000000e+00 -5.960464477539062500e-08 2.980232238769531250e-08 0.000000000000000000e+00 1.490116119384765625e-08 0.000000000000000000e+00 0.000000000000000000e+00 1.374800051578972671e-09 -5.789650188984434356e-17 4.238015272051143256e-09 -8.894730285646801349e-09 -7.441884442016544199e-09 0.000000000000000000e+00
-2.085143923759460449e-01 -2.562353909015655518e-01 -8.280436247787292814e-08 -5.611039325594902039e-02 -4.047119244933128357e-02 -6.316878646612167358e-02 -8.342754840850830078e-02 -8.342754840850830078e-02 0.000000000000000000e+00 -1.272362917661666870e-01 8.881216049194335938e-01 0.000000000000000000e+00 2.037490606307983398e-01 -6.513521075248718262e-02 -6.513521075248718262e-02 -6.513521075248718262e-02 -2.370543777942657471e-02 -4.368796572089195251e-02 -4.712030664086341858e-02 0.000000000000000000e+00 -4.806922748684883118e-02 1.765385349017378758e-08 -3.327504938255287925e-09 8.976901888502197835e-09 3.581777319183743202e-09 -2.611149074738250420e-09 1.432209018048524740e-09 -3.349336356543974316e-17 -5.393070434678293168e-10 -2.432372525618120562e-09 -1.141043037833355811e-09 -4.445540904998779297e-02
0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 1.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00
0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 -2.294157296419143677e-01 -2.294157296419143677e-01 -2.294157296419143677e-01 -4.588314592838287354e-01 2.294157296419143677e-01 2.294157296419143677e-01 0.000000000000000000e+00 7.254762649536132812e-01 -1.341104507446289062e-07 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 -7.450580596923828125e-09 7.450580596923828125e-09 0.000000000000000000e+00 0.000000000000000000e+00
-2.085143923759460449e-01 -2.562353909015655518e-01 -8.280436247787292814e-08 -5.611039325594902039e-02 -4.047119244933128357e-02 -6.316878646612167358e-02 -8.342754840850830078e-02 -8.342754840850830078e-02 0.000000000000000000e+00 -1.272362917661666870e-01 -1.118784397840499878e-01 0.000000000000000000e+00 -2.566668018698692322e-02 8.822332024574279785e-01 -1.177667826414108276e-01 -1.177667826414108276e-01 -1.289685815572738647e-01 8.943611755967140198e-03 5.511272232979536057e-03 0.000000000000000000e+00 1.183664500713348389e-01 -1.311319586250192515e-08 -3.327504938255287925e-09 8.976901888502197835e-09 3.581777319183743202e-09 -2.611149074738250420e-09 1.432209018048524740e-09 -3.349336356543974316e-17 -2.248587538389301699e-09 -7.230920306966481803e-10 -1.141043037833355811e-09 -4.445540904998779297e-02
-2.085143923759460449e-01 -2.562353909015655518e-01 -8.280436247787292814e-08 -5.611039325594902039e-02 -4.047119244933128357e-02 -6.316878646612167358e-02 -8.342754840850830078e-02 -8.342754840850830078e-02 0.000000000000000000e+00 -1.272362917661666870e-01 -1.118784397840499878e-01 0.000000000000000000e+00 -2.566668018698692322e-02 -1.177667826414108276e-01 8.822332024574279785e-01 -1.177667826414108276e-01 -1.289685815572738647e-01 8.943611755967140198e-03 5.511272232979536057e-03 0.000000000000000000e+00 1.183664500713348389e-01 -1.311319586250192515e-08 -3.327504938255287925e-09 8.976901888502197835e-09 3.581777319183743202e-09 -2.611149074738250420e-09 1.432209018048524740e-09 -3.349336356543974316e-17 -2.248587538389301699e-09 -7.230920306966481803e-10 -1.141043037833355811e-09 -4.445540904998779297e-02
-2.085143923759460449e-01 -2.562353909015655518e-01 -8.280436247787292814e-08 -5.611039325594902039e-02 -4.047119244933128357e-02 -6.316878646612167358e-02 -8.342754840850830078e-02 -8.342754840850830078e-02 0.000000000000000000e+00 -1.272362917661666870e-01 -1.118784397840499878e-01 0.000000000000000000e+00 -2.566668018698692322e-02 -1.177667826414108276e-01 -1.177667826414108276e-01 8.822332024574279785e-01 -1.289685815572738647e-01 8.943611755967140198e-03 5.511272232979536057e-03 0.000000000000000000e+00 1.183664500713348389e-01 -1.311319586250192515e-08 -3.327504938255287925e-09 8.976901888502197835e-09 3.581777319183743202e-09 -2.611149074738250420e-09 1.432209018048524740e-09 -3.349336356543974316e-17 -2.248587538389301699e-09 -7.230920306966481803e-10 -1.141043037833355811e-09 -4.445540904998779297e-02
-2.085143923759460449e-01 1.773938089609146118e-01 -2.630042433738708496e-01 -9.226075373589992523e-03 1.381746232509613037e-01 7.305283844470977783e-02 6.116405874490737915e-02 6.116406247019767761e-02 0.000000000000000000e+00 1.337705701589584351e-01 9.107606858015060425e-02 0.000000000000000000e+00 2.089428715407848358e-02 9.586954116821289062e-02 9.586954116821289062e-02 9.586954116821289062e-02 5.102722719311714172e-02 8.625655770301818848e-01 -6.922324746847152710e-02 0.000000000000000000e+00 -1.276545673608779907e-01 2.586422809258692723e-08 9.193191985445992032e-09 9.832008984744788904e-09 -6.563285914751304517e-09 -2.813834942827497798e-09 1.508184244158883303e-09 1.009600473575020978e-16 -7.469891927236460560e-10 7.817928526776540821e-10 4.174953716074014665e-09 -4.445545375347137451e-02
-2.085143923759460449e-01 1.773937046527862549e-01 2.191720157861709595e-02 -8.411234021186828613e-01 1.648828238248825073e-01 2.723165154457092285e-01 -3.046402893960475922e-02 -3.046402148902416229e-02 0.000000000000000000e+00 -1.728098094463348389e-01 -6.910544633865356445e-02 0.000000000000000000e+00 -1.585388742387294769e-02 -7.274258136749267578e-02 -7.274258136749267578e-02 -7.274258136749267578e-02 1.734097748994827271e-01 -8.220700919628143311e-02 -1.166042089462280273e-01 0.000000000000000000e+00 1.035339236259460449e-01 1.745569022659765324e-09 1.112960212878988386e-08 1.483805256441428355e-08 8.164888765094246992e-10 -6.299095023365453017e-09 6.863908330601020680e-10 -2.686794332042153049e-16 -5.226768795552061420e-09 -6.548324105182246058e-09 1.553580375457386253e-09 -4.445545375347137451e-02
-2.085143923759460449e-01 1.773937046527862549e-01 2.191708236932754517e-02 7.730449736118316650e-02 4.125340878963470459e-01 1.914700716733932495e-01 9.645622223615646362e-02 9.645622223615646362e-02 0.000000000000000000e+00 1.673047244548797607e-01 1.338666975498199463e-01 0.000000000000000000e+00 3.071113303303718567e-02 1.409123092889785767e-01 1.409123092889785767e-01 1.409123092889785767e-01 5.990355089306831360e-02 -2.092952579259872437e-01 7.330186963081359863e-01 0.000000000000000000e+00 5.951608996838331223e-03 5.953826320848065734e-09 -1.367439494970312808e-08 7.593689232976430503e-09 -2.448440117319705678e-09 -9.333366968178324896e-09 2.115126740420691931e-09 -3.236634652444849401e-17 -3.241375612361707681e-09 -3.370382584133579940e-10 2.268498722202139106e-09 -4.445545375347137451e-02
0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 1.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00
-2.085143923759460449e-01 1.773937046527862549e-01 2.191708236932754517e-02 7.730449736118316650e-02 -7.155913114547729492e-02 -5.368392914533615112e-02 -1.271562557667493820e-02 -1.271562837064266205e-02 0.000000000000000000e+00 -1.282655820250511169e-02 -1.558373868465423584e-02 0.000000000000000000e+00 -3.575153881683945656e-03 -1.640393212437629700e-02 -1.640393212437629700e-02 -1.640393212437629700e-02 -2.843404933810234070e-02 -5.710633099079132080e-02 -5.471913143992424011e-02 0.000000000000000000e+00 1.816883101128041744e-03 9.486835002899169922e-01 -2.412628532511007506e-07 -5.388965362840281159e-08 1.216739065057481639e-08 -1.900347434968807647e-08 -6.624961024215281213e-09 -5.347076003439654463e-16 2.021561584797382238e-08 7.821173930722125078e-09 1.908850144616280886e-08 -4.445545375347137451e-02
-2.085143923759460449e-01 1.773937046527862549e-01 2.191708236932754517e-02 7.730449736118316650e-02 -7.155913114547729492e-02 -5.368392914533615112e-02 -1.271562557667493820e-02 -1.271562837064266205e-02 0.000000000000000000e+00 -1.282655820250511169e-02 -1.558373868465423584e-02 0.000000000000000000e+00 -3.575153881683945656e-03 -1.640393212437629700e-02 -1.640393212437629700e-02 -1.640393212437629700e-02 -2.843404933810234070e-02 -5.710633099079132080e-02 -5.471913143992424011e-02 0.000000000000000000e+00 1.816912903450429440e-03 -1.054092869162559509e-01 9.428092241287231445e-01 -7.127434287212963682e-08 4.716810053650988266e-09 -2.148700239956724545e-08 8.256192396416395241e-10 -9.061837725901302929e-17 -4.619657989479719618e-09 4.095883632260211016e-09 4.187338920047523061e-09 -4.445545375347137451e-02
-2.085143923759460449e-01 1.773937046527862549e-01 2.191708236932754517e-02 7.730449736118316650e-02 -7.155913114547729492e-02 -5.368392914533615112e-02 -1.271562557667493820e-02 -1.271562837064266205e-02 0.000000000000000000e+00 -1.282655820250511169e-02 -1.558373868465423584e-02 0.000000000000000000e+00 -3.575153881683945656e-03 -1.640393212437629700e-02 -1.640393212437629700e-02 -1.640393212437629700e-02 -2.843404933810234070e-02 -5.710633099079132080e-02 -5.471913143992424011e-02 0.000000000000000000e+00 1.816912903450429440e-03 -1.054092869162559509e-01 -1.178511232137680054e-01 9.354144930839538574e-01 -5.579174100489581178e-08 1.621785550298682210e-08 8.256192396416395241e-10 -9.061837725901302929e-17 -7.253836198373164734e-09 4.095883632260211016e-09 4.187338920047523061e-09 -4.445545375347137451e-02
-2.085143923759460449e-01 1.773937046527862549e-01 2.191708236932754517e-02 7.730449736118316650e-02 -7.155913114547729492e-02 -5.368392914533615112e-02 -1.271562557667493820e-02 -1.271562837064266205e-02 0.000000000000000000e+00 -1.282655820250511169e-02 -1.558373868465423584e-02 0.000000000000000000e+00 -3.575153881683945656e-03 -1.640393212437629700e-02 -1.640393212437629700e-02 -1.640393212437629700e-02 -2.843404933810234070e-02 -5.710633099079132080e-02 -5.471913143992424011e-02 0.000000000000000000e+00 1.816912903450429440e-03 -1.054092869162559509e-01 -1.178511232137680054e-01 -1.336306333541870117e-01 9.258201718330383301e-01 -7.800033330340738758e-08 1.109225511441991330e-08 5.213207740082032634e-16 -1.006989158724991285e-08 -1.643738833934094146e-08 -1.634593083110758016e-08 -4.445545375347137451e-02
-2.085143923759460449e-01 1.773937046527862549e-01 2.191708236932754517e-02 7.730449736118316650e-02 -7.155913114547729492e-02 -5.368392914533615112e-02 -1.271562557667493820e-02 -1.271562837064266205e-02 0.000000000000000000e+00 -1.282655820250511169e-02 -1.558373868465423584e-02 0.000000000000000000e+00 -3.575153881683945656e-03 -1.640393212437629700e-02 -1.640393212437629700e-02 -1.640393212437629700e-02 -2.843404933810234070e-02 -5.710633099079132080e-02 -5.471913143992424011e-02 0.000000000000000000e+00 1.816912903450429440e-03 -1.054092869162559509e-01 -1.178511232137680054e-01 -1.336306333541870117e-01 -1.543033570051193237e-01 9.128709435462951660e-01 3.641674517496085173e-09 7.026194942802768944e-16 -2.360384243615953892e-08 1.420217454750627439e-08 1.953976536128720909e-08 -4.445545375347137451e-02
-2.085143923759460449e-01 1.773937046527862549e-01 2.191708236932754517e-02 7.730449736118316650e-02 -7.155913114547729492e-02 -5.368392914533615112e-02 -1.271562557667493820e-02 -1.271562837064266205e-02 0.000000000000000000e+00 -1.282655820250511169e-02 -1.558373868465423584e-02 0.000000000000000000e+00 -3.575153881683945656e-03 -1.640393212437629700e-02 -1.640393212437629700e-02 -1.640393212437629700e-02 -2.843404933810234070e-02 -5.710633099079132080e-02 -5.471913143992424011e-02 0.000000000000000000e+00 1.816912903450429440e-03 -1.054092869162559509e-01 -1.178511232137680054e-01 -1.336306333541870117e-01 -1.543033570051193237e-01 -1.825741231441497803e-01 8.944271802902221680e-01 2.665600717932647967e-08 -3.026785222459693614e-08 -2.932143416956023430e-08 -3.849172713898951770e-08 -4.445545375347137451e-02
0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 0.000000000000000000e+00 1.000000119209289551e+00 5.960464477539062500e-08 5.960464477539062500e-08 5.960464477539062500e-08 0.000000000000000000e+00
-2.085143923759460449e-01 1.773937046527862549e-01 2.191708236932754517e-02 7.730449736118316650e-02 -7.155913114547729492e-02 -5.368392914533615112e-02 -1.271562557667493820e-02 -1.271562837064266205e-02 0.000000000000000000e+00 -1.282655820250511169e-02 -1.558373868465423584e-02 0.000000000000000000e+00 -3.575153881683945656e-03 -1.640393212437629700e-02 -1.640393212437629700e-02 -1.640393212437629700e-02 -2.843404933810234070e-02 -5.710633099079132080e-02 -5.471913143992424011e-02 0.000000000000000000e+00 1.816912903450429440e-03 -1.054092869162559509e-01 -1.178511232137680054e-01 -1.336306333541870117e-01 -1.543033570051193237e-01 -1.825741827487945557e-01 -2.236067950725555420e-01 -5.136748626455300837e-08 -5.000000000000000000e-01 -5.000000000000000000e-01 -5.000000000000000000e-01 -4.445545375347137451e-02
-2.085143923759460449e-01 1.773937046527862549e-01 2.191708236932754517e-02 7.730449736118316650e-02 -7.155913114547729492e-02 -5.368392914533615112e-02 -1.271562557667493820e-02 -1.271562837064266205e-02 0.000000000000000000e+00 -1.282655820250511169e-02 -1.558373868465423584e-02 0.000000000000000000e+00 -3.575153881683945656e-03 -1.640393212437629700e-02 -1.640393212437629700e-02 -1.640393212437629700e-02 -2.843404933810234070e-02 -5.710633099079132080e-02 -5.471913143992424011e-02 0.000000000000000000e+00 1.816912903450429440e-03 -1.054092869162559509e-01 -1.178511232137680054e-01 -1.336306333541870117e-01 -1.543033570051193237e-01 -1.825741827487945557e-01 -2.236067950725555420e-01 8.237159399016036332e-09 8.333333730697631836e-01 -1.666666716337203979e-01 -1.666666716337203979e-01 -4.445545375347137451e-02
-2.085143923759460449e-01 1.773937046527862549e-01 2.191708236932754517e-02 7.730449736118316650e-02 -7.155913114547729492e-02 -5.368392914533615112e-02 -1.271562557667493820e-02 -1.271562837064266205e-02 0.000000000000000000e+00 -1.282655820250511169e-02 -1.558373868465423584e-02 0.000000000000000000e+00 -3.575153881683945656e-03 -1.640393212437629700e-02 -1.640393212437629700e-02 -1.640393212437629700e-02 -2.843404933810234070e-02 -5.710633099079132080e-02 -5.471913143992424011e-02 0.000000000000000000e+00 1.816912903450429440e-03 -1.054092869162559509e-01 -1.178511232137680054e-01 -1.336306333541870117e-01 -1.543033570051193237e-01 -1.825741827487945557e-01 -2.236067950725555420e-01 8.237159399016036332e-09 -1.666666567325592041e-01 8.333333730697631836e-01 -1.666666716337203979e-01 -4.445545375347137451e-02
-2.085143923759460449e-01 1.773937046527862549e-01 2.191708236932754517e-02 7.730449736118316650e-02 -7.155913114547729492e-02 -5.368392914533615112e-02 -1.271562557667493820e-02 -1.271562837064266205e-02 0.000000000000000000e+00 -1.282655820250511169e-02 -1.558373868465423584e-02 0.000000000000000000e+00 -3.575153881683945656e-03 -1.640393212437629700e-02 -1.640393212437629700e-02 -1.640393212437629700e-02 -2.843404933810234070e-02 -5.710633099079132080e-02 -5.471913143992424011e-02 0.000000000000000000e+00 1.816912903450429440e-03 -1.054092869162559509e-01 -1.178511232137680054e-01 -1.336306333541870117e-01 -1.543033570051193237e-01 -1.825741827487945557e-01 -2.236067950725555420e-01 8.237159399016036332e-09 -1.666666567325592041e-01 -1.666666716337203979e-01 8.333333730697631836e-01 -4.445545375347137451e-02
"""
        fd = io.StringIO(U_wm_txt)
        U_wm = np.loadtxt(fd)

        V_wm_txt = """-1.767766773700714111e-01 -1.767765879631042480e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01 -1.767766773700714111e-01
                    0.000000000000000000e+00 -9.837387800216674805e-01 3.279125690460205078e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02 3.279130160808563232e-02
                    0.000000000000000000e+00 1.505072333429779974e-07 -9.831921458244323730e-01 3.390312939882278442e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02 3.390317410230636597e-02
                    0.000000000000000000e+00 2.746482508086955932e-08 5.154015525477007031e-08 -9.826074838638305664e-01 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02 3.509312495589256287e-02
                    0.000000000000000000e+00 0.000000000000000000e+00 -3.193938269419049902e-08 -1.562153073564331862e-07 9.819806218147277832e-01 -3.636960312724113464e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02 -3.636964783072471619e-02
                    0.000000000000000000e+00 -3.295778983058994527e-09 9.410411117016792559e-09 -1.995252318920393009e-08 8.189937261704471894e-08 9.813067317008972168e-01 -3.774251416325569153e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02 -3.774257376790046692e-02
                    0.000000000000000000e+00 2.087326755884078011e-08 1.198900267951330534e-08 -1.535033655741813163e-09 2.130445686532311811e-08 -2.012706232790151262e-07 9.805808067321777344e-01 -3.922325000166893005e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02 -3.922322019934654236e-02
                    0.000000000000000000e+00 9.887337171221588505e-09 -1.611629407705095218e-08 -9.497119535240017285e-09 1.963431905949164502e-08 -1.565046581220030930e-08 -1.398128830487621599e-07 9.797958731651306152e-01 -4.082479700446128845e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02 -4.082482680678367615e-02
                    0.000000000000000000e+00 1.428170914863358121e-08 -1.214313805064648477e-08 3.750906074628801434e-08 -3.401964221438902314e-08 1.505574864779646305e-08 -2.137613641650659702e-08 1.680548962212924380e-07 9.789449572563171387e-01 -4.256285727024078369e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02 -4.256282746791839600e-02
                    0.000000000000000000e+00 1.098592994352998176e-09 2.109307217779132770e-08 -1.316602649126252800e-08 -3.625493461001383366e-09 2.342146565581515461e-08 -1.706157215508596892e-09 -1.381335046346521267e-08 -2.227207041016754374e-08 2.085144221782684326e-01 -9.640233516693115234e-01 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02 3.597661852836608887e-02
                    0.000000000000000000e+00 8.788743954823985405e-09 -2.289171341374185431e-08 -1.344526445734572917e-08 2.244378549676184775e-08 -1.101351365662139870e-08 4.983530921265355573e-09 -2.742649485298898071e-08 -1.037604135945002781e-07 9.555331468582153320e-01 1.648655682802200317e-01 -5.335228517651557922e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02 -5.335231497883796692e-02
                    0.000000000000000000e+00 -4.394371977411992702e-09 -6.690818454835323337e-10 8.165036646801127063e-09 1.843167218851249345e-08 1.309399921822773649e-09 -1.242353420138897491e-08 2.631948348152945982e-08 -2.201520743483342812e-08 6.336546931606790167e-08 1.121140957849320330e-08 9.759000539779663086e-01 -4.879503324627876282e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02 -4.879500344395637512e-02
                    0.000000000000000000e+00 -1.208452271583837501e-08 -1.615762812434695661e-08 2.023020195807134769e-09 5.759353882694995264e-09 -5.022893212469625723e-09 6.682832953686101973e-09 3.498403788881887522e-10 3.904229828322058893e-09 1.304456320738722752e-09 3.731337461232442365e-10 3.209518206759298664e-09 2.236067950725555420e-01 -9.591372013092041016e-01 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02 4.086279496550559998e-02
                    0.000000000000000000e+00 -2.416904543167675001e-08 -8.085382141587160731e-09 3.870623288548813434e-08 -3.304977624907223799e-08 3.451143726351801888e-08 -1.274910665927109221e-08 -1.312163711020275514e-08 -1.091719070700492011e-08 -3.466609443947277214e-09 -3.466609443947277214e-09 -4.998330993544186640e-08 9.486833810806274414e-01 1.733661741018295288e-01 -6.233609840273857117e-02 -6.233608350157737732e-02 -6.233608350157737732e-02 -6.233608350157737732e-02 -6.233608350157737732e-02 -6.233608350157737732e-02 -6.233608350157737732e-02 -6.233608350157737732e-02 -6.233608350157737732e-02 -6.233608350157737732e-02 -6.233608350157737732e-02 -6.233608350157737732e-02 -6.233608350157737732e-02 -6.233608350157737732e-02 -6.233608350157737732e-02 -6.233608350157737732e-02 -6.233608350157737732e-02 -6.233608350157737732e-02
                    0.000000000000000000e+00 -2.197185988705996351e-09 1.868175170116614936e-09 5.526854085502463931e-09 9.728848837653458759e-09 1.338382471516297301e-08 -7.069098195700007636e-09 -4.461396141408613403e-09 1.126538973217350303e-09 -1.463069665419425291e-08 -1.592179610376831533e-09 3.130987735744383826e-08 1.341810573762813874e-08 5.967527361150359866e-09 9.718253016471862793e-01 -5.716615542769432068e-02 -5.716620013117790222e-02 -5.716620013117790222e-02 -5.716620013117790222e-02 -5.716620013117790222e-02 -5.716620013117790222e-02 -5.716620013117790222e-02 -5.716620013117790222e-02 -5.716620013117790222e-02 -5.716620013117790222e-02 -5.716620013117790222e-02 -5.716620013117790222e-02 -5.716620013117790222e-02 -5.716620013117790222e-02 -5.716620013117790222e-02 -5.716620013117790222e-02 -5.716620013117790222e-02
                    0.000000000000000000e+00 -2.197185988705996351e-09 -2.676713251048568054e-08 1.766990287421776884e-08 -9.565469527572645347e-10 1.459123311065013695e-08 -3.186638153351850633e-08 2.736573456729729514e-08 -7.682722014124010457e-09 -6.985242606560859713e-09 -1.397306603756476306e-09 -1.397306603756476306e-09 -1.963046969422066468e-08 -4.729307612194588728e-09 -1.013996495657920605e-07 9.701425433158874512e-01 -6.063390150666236877e-02 -6.063390150666236877e-02 -6.063390150666236877e-02 -6.063390150666236877e-02 -6.063390150666236877e-02 -6.063390150666236877e-02 -6.063390150666236877e-02 -6.063390150666236877e-02 -6.063390150666236877e-02 -6.063390150666236877e-02 -6.063390150666236877e-02 -6.063390150666236877e-02 -6.063390150666236877e-02 -6.063390150666236877e-02 -6.063390150666236877e-02 -6.063390150666236877e-02
                    0.000000000000000000e+00 2.197185988705996351e-09 1.795626936029748322e-08 -2.344724769898220984e-08 4.098288286513707135e-08 -1.070708965933420131e-09 -6.622472792372491313e-09 -8.485117497514238494e-09 -4.627186811489991669e-08 3.786434987773645844e-08 6.114476702734350511e-10 1.195698562383995522e-08 3.646148660774173322e-10 2.227259709997042592e-09 4.135572950758614752e-08 1.068956905214690778e-07 -9.682458639144897461e-01 6.454971432685852051e-02 6.454971432685852051e-02 6.454971432685852051e-02 6.454971432685852051e-02 6.454971432685852051e-02 6.454971432685852051e-02 6.454971432685852051e-02 6.454971432685852051e-02 6.454971432685852051e-02 6.454971432685852051e-02 6.454971432685852051e-02 6.454971432685852051e-02 6.454971432685852051e-02 6.454971432685852051e-02 6.454971432685852051e-02
                    0.000000000000000000e+00 3.735216225209114782e-08 -3.836712636484662653e-08 1.434548302370330930e-08 3.521620328683638945e-09 3.880086474339350389e-09 4.434829747879120987e-08 -7.150822511903243139e-08 2.470412141519773286e-08 -1.526749926483716990e-08 -2.228982332042050984e-09 -5.895666177480052283e-08 5.598381491722648207e-08 1.044586639409317286e-10 -2.061061366021021968e-08 -1.532405313753315568e-09 5.946921532995474990e-08 9.660917520523071289e-01 -6.900647282600402832e-02 -6.900656223297119141e-02 -6.900656223297119141e-02 -6.900656223297119141e-02 -6.900656223297119141e-02 -6.900656223297119141e-02 -6.900656223297119141e-02 -6.900656223297119141e-02 -6.900656223297119141e-02 -6.900656223297119141e-02 -6.900656223297119141e-02 -6.900656223297119141e-02 -6.900656223297119141e-02 -6.900656223297119141e-02
                    0.000000000000000000e+00 -2.856341829726716242e-08 3.309713747512432747e-08 -1.402753113666221907e-08 1.225634704837830213e-09 -1.174256691882646919e-08 2.207799632003570878e-08 -2.523319153624470346e-08 -5.446713302603711782e-08 1.763714152502871002e-08 -6.577248079508990486e-09 -2.699921353155332326e-08 1.027689933152942103e-08 -6.486907899727611948e-09 4.181166524119817041e-10 -3.525705238871523761e-08 -1.337097543796517130e-08 -1.099386111036437796e-07 9.636241793632507324e-01 -7.412489503622055054e-02 -7.412492483854293823e-02 -7.412492483854293823e-02 -7.412492483854293823e-02 -7.412492483854293823e-02 -7.412492483854293823e-02 -7.412492483854293823e-02 -7.412492483854293823e-02 -7.412492483854293823e-02 -7.412492483854293823e-02 -7.412492483854293823e-02 -7.412492483854293823e-02 -7.412492483854293823e-02
                    0.000000000000000000e+00 -1.757748790964797081e-08 5.239157374603564676e-08 -2.509396601624303003e-08 1.870028043526872352e-08 -1.396977378220753963e-08 1.207108635270515151e-08 -1.512353087207429780e-08 1.772047752979233337e-08 -1.293792006862304333e-08 1.005970862166805091e-10 1.144613470671629329e-08 -3.205427034913554962e-08 -4.114592222492774454e-09 2.580717683997590939e-08 -3.080884525274996122e-08 4.649092844033475558e-08 -2.729736259254877950e-08 -2.482490835120643169e-08 9.607689976692199707e-01 -8.006413280963897705e-02 -8.006407320499420166e-02 -8.006407320499420166e-02 -8.006407320499420166e-02 -8.006407320499420166e-02 -8.006407320499420166e-02 -8.006407320499420166e-02 -8.006407320499420166e-02 -8.006407320499420166e-02 -8.006407320499420166e-02 -8.006407320499420166e-02 -8.006407320499420166e-02
                    0.000000000000000000e+00 -2.197186077523838321e-08 -7.750841746201331262e-09 2.600037962707801853e-09 -2.070511406770947360e-08 -2.357284323295516515e-08 1.806359684053404635e-08 -1.322884202181739965e-08 -8.021116215672918770e-09 -1.291157314398105882e-08 -7.323636808109768026e-09 1.082922196360414091e-08 -3.370082879428082379e-08 -9.486438301564703579e-09 1.122863402258644783e-08 -5.535171432313745754e-09 -3.206865439864259315e-09 -2.381813679619426694e-08 -1.127743054496477271e-08 2.627396611387666781e-08 2.886751294136047363e-01 -9.353340864181518555e-01 6.466589868068695068e-02 6.466589868068695068e-02 6.466589868068695068e-02 6.466589868068695068e-02 6.466589868068695068e-02 6.466589868068695068e-02 6.466589868068695068e-02 6.466589868068695068e-02 6.466589868068695068e-02 6.466589868068695068e-02
                    0.000000000000000000e+00 1.098593038761919161e-08 8.280852448194764293e-09 1.152703532625309890e-08 -2.249936770226668159e-08 -1.791651627058854501e-08 2.371992380290066649e-08 1.030887730735230434e-08 6.154410314707092766e-10 -4.275014120480591373e-09 1.312921438234582183e-09 1.946578187528302806e-08 -1.594768761492559861e-08 8.161196163314343721e-10 1.002281990736264561e-08 4.886641313817108312e-09 3.023996164586151281e-09 -6.350315828740349389e-09 -1.070202415576204658e-08 3.429995132364638266e-08 2.886751294136047363e-01 6.466589123010635376e-02 -9.353340864181518555e-01 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02
                    0.000000000000000000e+00 1.098593038761919161e-08 8.280852448194764293e-09 2.692917444591103049e-09 -1.280964667671469215e-08 -6.434463628579578653e-09 8.065230261422584590e-09 9.555347624257137795e-09 -1.380897618474818955e-10 -5.028545135843387470e-09 5.593903118494836235e-10 1.871224952765260241e-08 -1.670121996255602426e-08 6.258904505784812500e-11 9.269288447910639661e-09 4.133110742543522065e-09 2.270465593312565034e-09 -7.103846400013935636e-09 -2.013723854332738483e-09 2.602066828671922849e-08 2.886751294136047363e-01 6.466589123010635376e-02 6.466589123010635376e-02 -9.353340864181518555e-01 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02
                    0.000000000000000000e+00 1.098593038761919161e-08 8.280852448194764293e-09 2.692917444591103049e-09 -1.280964667671469215e-08 -6.434463628579578653e-09 8.065230261422584590e-09 9.555347624257137795e-09 -1.380897618474818955e-10 -5.028545135843387470e-09 5.593903118494836235e-10 1.871224952765260241e-08 -1.670121996255602426e-08 6.258904505784812500e-11 9.269288447910639661e-09 4.133110742543522065e-09 2.270465593312565034e-09 -7.103846400013935636e-09 -2.013723854332738483e-09 2.602066828671922849e-08 2.886751294136047363e-01 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 -9.353340864181518555e-01 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02
                    0.000000000000000000e+00 2.197185988705996351e-09 1.134812155356712537e-08 2.034895585367735293e-09 -1.346766875798266483e-08 -7.092486153936761184e-09 7.407208624243821760e-09 8.897326431167584815e-09 -7.961115100485471885e-10 -5.686567217111360151e-09 -9.863146410715728507e-11 1.805422833456304943e-08 -1.735924115564557724e-08 -5.954327031432171680e-10 8.611267254821086681e-09 3.475088883320154309e-09 1.612443845111499741e-09 -7.761868481281908316e-09 -2.671745713556106239e-09 2.536264709362967551e-08 2.886751294136047363e-01 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 -9.353340864181518555e-01 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02
                    0.000000000000000000e+00 -6.591557966117989054e-09 1.441538888258264706e-08 1.376873948188972463e-09 -1.412569083925063751e-08 -7.750507791115524014e-09 1.120506709639812470e-08 4.499544736802363332e-09 -1.468601906751132447e-09 -1.536319338413250080e-08 -2.324675341114357252e-09 1.582818320855494676e-08 -1.502699475963709119e-08 -1.988476272529737798e-09 1.412324568406120306e-08 1.034234209384976566e-08 -4.093156036333311931e-09 8.525513628399039590e-09 5.298036676038009318e-09 2.009013577719542809e-08 2.886751294136047363e-01 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 -9.353340864181518555e-01 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02
                    0.000000000000000000e+00 1.098593038761919161e-08 2.149714894983389968e-08 4.733343050844496247e-09 -1.076922195863971865e-08 -1.327848586640811845e-08 1.758354883918400446e-08 2.682389643737792539e-09 4.395337427354206739e-10 -4.450922741483509526e-09 1.137013816432386193e-09 1.928987281019090005e-08 -2.524017794769406464e-08 -1.025787899067154285e-09 1.968928309281636757e-08 2.925479192228408465e-09 5.253785850811709679e-09 1.042187491862023307e-08 7.194397078080783103e-09 2.198649617923820188e-08 2.886751294136047363e-01 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 -9.353340864181518555e-01 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02 6.466589123010635376e-02
                    0.000000000000000000e+00 -2.197186077523838321e-08 2.088446748871319869e-08 3.953712912618811970e-10 -2.618045336078012042e-08 -2.159760192910198384e-08 3.340647580785116588e-08 -4.591483193649992245e-09 -1.208047173406612274e-08 -9.520347177272014960e-09 -3.932411285489934016e-09 1.422044881849160447e-08 -3.030960371575019963e-08 -6.095213667123289270e-09 1.922320969072188745e-08 -1.265886728774034964e-09 1.062419929809266250e-09 6.230509441706999496e-09 3.003030268899919975e-09 1.779513603139548650e-08 2.886751294136047363e-01 6.466589868068695068e-02 6.466589868068695068e-02 6.466589868068695068e-02 6.466589868068695068e-02 6.466589868068695068e-02 6.466589868068695068e-02 6.466589868068695068e-02 -9.353340864181518555e-01 6.466589868068695068e-02 6.466589868068695068e-02 6.466589868068695068e-02
                    0.000000000000000000e+00 1.757748790964797081e-08 -1.494540136093291949e-08 1.762399648441714817e-08 2.044005142920468643e-08 2.330778059445037798e-08 -8.071096857520387857e-08 6.532039975581938052e-08 -1.222708956305496031e-08 2.068234117302836239e-08 5.781179535091496291e-09 -1.237168145706846190e-08 -5.217001231017093232e-08 -7.466519846843766572e-09 1.094687629432655740e-08 1.456094000928942478e-08 -5.621958010237904091e-08 6.347838876763489679e-08 -1.500990620684206078e-08 1.892525602897876524e-08 5.000000000000000000e-01 1.120046004652976990e-01 1.120046004652976990e-01 1.120046004652976990e-01 1.120046004652976990e-01 1.120046004652976990e-01 1.120046004652976990e-01 1.120046004652976990e-01 1.120046004652976990e-01 -4.653456211090087891e-01 -4.653456211090087891e-01 -4.653456211090087891e-01
                    0.000000000000000000e+00 8.788743954823985405e-09 1.338163690967064667e-09 -3.078895360886235721e-09 -3.782909097083120287e-09 -5.761913168811361174e-11 -5.761913168811361174e-11 8.883077384780335706e-09 -3.053214570059026300e-09 -8.332059486804155313e-09 -8.814781127242099501e-10 3.656737135315779597e-09 -6.855305212383200342e-11 -6.855305212383200342e-11 9.138145351528237370e-09 6.316371425896250003e-09 -2.065531301553846788e-09 1.659758552818857424e-09 6.380674655304119369e-09 -2.103115015472667437e-09 -7.979204852404109261e-09 -5.286221460565343477e-10 -5.286221460565343477e-10 -5.286221460565343477e-10 -5.286221460565343477e-10 -5.286221460565343477e-10 -5.286221460565343477e-10 -5.286221460565343477e-10 -5.286221460565343477e-10 -5.773502588272094727e-01 7.886751294136047363e-01 -2.113248556852340698e-01
                    0.000000000000000000e+00 8.788743954823985405e-09 1.338163690967064667e-09 -7.495954967851048423e-09 -4.537437092722029774e-11 -4.537437092722029774e-11 -4.537437092722029774e-11 -4.537437092722029774e-11 -4.537437092722029774e-11 -4.537437092722029774e-11 -4.537437092722029774e-11 -4.537437092722029774e-11 -4.537437092722029774e-11 -4.537437092722029774e-11 -4.537437092722029774e-11 1.846984787334804423e-08 -1.505776481280918233e-08 -1.566020646492916057e-10 -1.566020646492916057e-10 1.887739564665480430e-08 -1.522652226526588493e-08 -3.253581848383646502e-10 -3.253581848383646502e-10 -3.253581848383646502e-10 -3.253581848383646502e-10 -3.253581848383646502e-10 -3.253581848383646502e-10 -3.253581848383646502e-10 -3.253581848383646502e-10 -5.773502588272094727e-01 -2.113248556852340698e-01 7.886751294136047363e-01
                    -9.842509627342224121e-01 3.175002336502075195e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02 3.175002709031105042e-02
                    """
        fd = io.StringIO(V_wm_txt)
        V_wm = np.loadtxt(fd)

        watermark = np.dot(U_wm, np.dot(np.diag(S_extracted), V_wm))
        watermarks.append(watermark)

    return watermarks


def detection(input1, input2, input3):
    """
    input1: original image
    input2: watermarked image
    input3: attacked image
    """
    original_img = cv2.imread(input1, 0)
    watermarked_img = cv2.imread(input2, 0)
    attacked_img = cv2.imread(input3, 0)

    print("2:", np.allclose(watermarked_img, attacked_img))

    original_watermarks = extraction(watermarked_img, original_img)

    attacked_watermarks = extraction(attacked_img, original_img)

    max_sim = None
    for o_w in original_watermarks:
        for a_w in attacked_watermarks:
            act_sim = similarity(o_w, a_w)
            if max_sim is None or act_sim > max_sim:
                max_sim = act_sim

    wpsnr_res = wpsnr(watermarked_img, attacked_img)
    detected = 1 if max_sim > THRESHOLD else 0
    return detected, wpsnr_res


if __name__ == "__main__":
    original_image = 'lena_grey.bmp'
    watermarked_image = 'findbrivateknowledge_embedded.bmp'
    attacked_image = 'results/findbrivateknowledge_attacked0.bmp'

    detected, wpsnr_value = detection(
        original_image, watermarked_image, attacked_image)
    print("Detected:", detected, " with WPSNR:", wpsnr_value)
