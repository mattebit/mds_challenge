import io
from math import sqrt

import cv2
import numpy as np
import pywt
from numpy.linalg import svd
from scipy.signal import convolve2d

BLOCK_SIZE = 64
THRESHOLD_W = 70
LOW_THRESHOLD = 100
HIGH_THRESHOLD = 150
ALPHA = 5.0
THRESHOLD = 0.9999


def wpsnr(img1, img2):
    img1 = np.float32(img1) / 255.0
    img2 = np.float32(img2) / 255.0
    difference = img1 - img2
    same = not np.any(difference)
    if same is True:
        return 9999999
    w = np.genfromtxt('csf.csv', delimiter=',')
    ew = convolve2d(difference, np.rot90(w, 2), mode='valid')
    decibels = 20.0 * np.log10(1.0 / sqrt(np.mean(np.mean(ew ** 2))))
    return decibels


def similarity(X, X_star):
    norm_X = np.sqrt(np.sum(np.multiply(X, X)))
    norm_X_star = np.sqrt(np.sum(np.multiply(X_star, X_star)))

    if norm_X == 0 or norm_X_star == 0:
        return 0.0

    s = np.sum(np.multiply(X, X_star)) / (norm_X * norm_X_star)
    return s


def select_best_regions(edge_map):
    h, w = edge_map.shape
    regions = []

    for i in range(1, h - BLOCK_SIZE + 1, 8):
        for j in range(1, w - BLOCK_SIZE + 1, 8):
            block = edge_map[i:i + BLOCK_SIZE, j:j + BLOCK_SIZE]
            edge_density = np.mean(block)

            regions.append((i, j, edge_density))

    regions = sorted(regions, key=lambda x: x[2], reverse=True)

    selected_regions = []
    selected_regions.append(regions[0])
    selected_regions.append(regions[len(regions) - 1])
    selected_regions.append(regions[int(len(regions) // 2)])

    return [(i, j) for i, j, _ in selected_regions]


def watermark_to_bytes(watermark: np.ndarray) -> np.ndarray:
    was_matrix = False
    if len(watermark) < 1023:
        was_matrix = True
        size = watermark.shape
        watermark = watermark.flatten()

    c = 1
    act_b = ""
    w_b = []
    for b in watermark:
        act_b += str(b)
        if c == 8:
            w_b.append(int(act_b, 2))
            c = 0
            act_b = ""
        c += 1

    w_b = np.array(w_b)

    if was_matrix:
        w_b = np.resize(np.array(w_b), (32, 32))

    return w_b


def extraction(image_wm, original):
    edges = cv2.Canny(original, LOW_THRESHOLD, HIGH_THRESHOLD)
    regions = select_best_regions(edges)

    watermarks = []
    for region in regions:
        x, y = region

        LL_w, (LH_w, HL_w, HH_w) = pywt.dwt2(image_wm[x:x + BLOCK_SIZE, y:y + BLOCK_SIZE], 'haar')
        U_w, S_w, V_w = svd(LL_w)

        LL, (LH, HL, HH) = pywt.dwt2(original[x:x + BLOCK_SIZE, y:y + BLOCK_SIZE], 'haar')
        U, S, V = svd(LL)

        S_extracted = abs(S_w - S) / ALPHA

        U_wm_txt = """-1.818043495210275307e-01 -9.007190817685084561e-03 -2.402551503218046669e-01 1.847796302427758830e-01 6.957272805469630894e-01 -5.170367664244746031e-02 -1.628295762604939009e-02 1.585282468087503316e-16 3.088525965223750884e-17 -1.737295855438360026e-17 -9.651643641324221513e-19 -1.725231300886704624e-17 -5.477307766451495843e-17 4.825821820662110756e-18 2.123361601091328579e-17 -1.218520009717182976e-17 -9.392255718463632525e-17 7.721314913059377210e-18 2.509427346744297747e-17 2.011764471488517342e-17 3.088525965223750884e-17 1.351230109785391012e-17 7.721314913059377210e-18 -7.238732730993165749e-18 -7.118087185476613269e-18 4.632788947835626326e-17 7.721314913059377210e-18 1.651335904257816018e-18 8.686479277191800132e-18 -1.640779419025117734e-17 -1.737295855438360026e-17 6.229166446767406828e-01
-1.743519813412400532e-01 1.796188250352648841e-01 2.183404828202019088e-01 1.211028400045852937e-01 5.932077672922698719e-01 -2.396220336146885621e-01 3.473821804846238814e-02 -7.496795091741059706e-17 -8.696581250795349358e-17 -3.374635616436423334e-17 -6.439785235776156336e-17 3.774366952228401937e-17 -3.248788713905539574e-17 -1.726364806107479382e-17 -5.395446219953506806e-18 2.956825774708537183e-17 -3.808912487246906399e-17 -1.314704607745801204e-17 -2.101571352134605239e-17 -2.865654469710386350e-17 -1.278250955411248267e-17 1.317964641510262759e-17 1.580253556306530565e-17 -2.092142946767161468e-17 -1.004459034086906045e-17 2.967865468721437489e-17 -5.909650667327182229e-18 2.219404479499958122e-17 -2.745586880486921551e-17 6.225286684205785964e-18 1.872476055908428199e-17 -6.815270222355813701e-01
-1.824653779736834514e-01 -2.776319038810024509e-01 1.102574590688916722e-01 -4.970115197862549211e-02 1.959114611901445757e-01 8.861183685378718478e-01 -1.702914977803640373e-01 1.999739628809104612e-16 -1.663266192663664395e-18 5.846656344066956322e-17 -1.592697702902847175e-17 3.181767782163881563e-17 -8.197125173732551750e-17 4.368319388687842952e-17 1.825804188591627993e-17 9.834395789016158256e-18 -1.991091570629166753e-17 -9.557095152621508580e-18 -7.559583347394490203e-18 3.885016599951971734e-19 -5.619842468744871786e-17 -5.406348449241334090e-18 1.749296628710529061e-17 1.320872655075038163e-17 -3.665342285215199011e-18 -6.248574345095129729e-18 -1.243486924918074789e-17 -3.264823292893504569e-17 -6.786770650663965475e-18 6.448140757186233317e-18 -2.029599858292126933e-18 -1.497121975586572229e-01
-1.680920906483728272e-01 1.248057456767703854e-01 -8.630289117613779148e-02 -2.715149827949903671e-01 2.620677967987994350e-02 1.723434007085676289e-01 9.189825500418848936e-01 -1.066755153254157620e-15 7.106858633278806504e-17 8.659538514932254120e-17 -2.887569569243682718e-17 -3.957027291537997437e-17 1.465664710006007214e-17 4.830491110765864130e-17 -1.030590682852092065e-16 -3.535497152163198455e-17 -3.528372408163849432e-18 3.339773364920372380e-19 2.050372026156345083e-17 2.567772821287030533e-18 3.338290994271675316e-18 5.074642878651103655e-19 -2.105902763208391853e-18 1.776912116817447017e-17 -5.619402284417717397e-18 1.296398746695841506e-17 -4.337969187563755090e-18 -5.008395823150563696e-18 -6.222630084626775688e-18 -2.464874438814889703e-18 2.880668150038975735e-17 9.057022111615284365e-03
-1.818043495210274751e-01 -9.007190817685091500e-03 -2.402551503218045559e-01 1.847796302427759385e-01 -9.938961150670899691e-02 7.386239520349780797e-03 2.326136803722038925e-03 5.061542187785317282e-01 -7.697985126381230447e-01 6.928312239032811959e-02 -5.967296580137201878e-02 -1.291778395544985988e-16 -1.769824296801798205e-17 4.645540090991811010e-17 2.659363003996689896e-17 1.201228275364619904e-16 -3.091785214151166209e-17 3.295772651118027375e-18 -2.464527587236553984e-17 5.354728744141749209e-17 -3.529573142963662569e-17 -2.667024359426572387e-17 -4.081302406909909717e-19 1.081076422695177892e-17 -3.809657924475795387e-18 -1.840550073121077733e-17 -2.942584456928737978e-18 1.655117292648026625e-17 1.059066396753011003e-17 -1.639334017964414098e-18 -1.334114634519116594e-17 -8.898809209667724041e-02
-1.743519813412401920e-01 1.796188250352649951e-01 2.183404828202011871e-01 1.211028400045850717e-01 -8.474396675603861062e-02 3.423171908781259820e-02 -4.962602578352079755e-03 -2.824832026689224063e-01 -8.451269781906949052e-02 5.088248716755232604e-01 -7.150531107718473001e-01 -9.204456871015339177e-16 -5.561631420829293628e-17 5.336618343625660293e-17 7.497330384043677452e-17 -2.080006617570181422e-17 2.724478366749519331e-17 2.043749323794085580e-17 6.481234914199272021e-17 -3.109353264547719426e-17 1.072534657753768291e-17 -3.547350855970824531e-17 -4.400461628617509747e-17 -2.931626713180335237e-17 6.644309225872827754e-18 -2.448532829711616345e-17 1.802913604561246755e-17 -7.910852869635288738e-18 9.201734501232701699e-18 -8.886654077509035188e-19 3.308649414952074545e-18 9.736100317651166791e-02
-1.824653779736834514e-01 -2.776319038810023399e-01 1.102574590688917278e-01 -4.970115197862624151e-02 -2.798735159859205845e-02 -1.265883383625532876e-01 2.432735682576547126e-02 -7.121576716750008806e-01 -5.041679942249606139e-01 -2.722558193830406092e-01 1.471927655441946370e-01 2.028066478451488556e-16 -3.422455597606358005e-17 4.214230059696051633e-17 -7.149164820982759675e-17 -3.906467819009160258e-17 1.429437843669882626e-17 -1.646792177163642835e-17 -2.754670560624795709e-17 2.550845537630587556e-17 4.216051956725587613e-17 6.437033384669803234e-18 -1.601383708194255281e-17 1.965926476777632386e-17 -2.683065675731714943e-17 7.222659196235582089e-18 1.066107418156944273e-17 1.872685043005177016e-17 -6.600018887041743088e-18 -3.238298374691763928e-18 1.732414369261136134e-18 2.138745679409390088e-02
-1.680920906483728272e-01 1.248057456767704410e-01 -8.630289117613801353e-02 -2.715149827949908112e-01 -3.743825668554183472e-03 -2.462048581550969895e-02 -1.312832214345550641e-01 -1.182601151694924607e-01 -5.679211731845745792e-02 7.206363332993698245e-01 5.662290462721611961e-01 1.525991657814400583e-15 3.409753008310816324e-17 1.000860636720194106e-17 4.603938596475353998e-17 -2.327832956285574114e-17 2.018098320831127730e-17 -6.074266386211375304e-17 -2.242506417383192387e-17 1.848052459592882408e-17 6.686261422724140142e-18 1.231093544815809212e-17 1.486341411294235278e-17 2.266368157979944931e-17 -5.098430680609951830e-18 -1.415638534307892879e-17 -5.001166376650989635e-18 -9.719189286035681638e-18 2.200688121667210267e-17 -1.428326337392149240e-17 7.427238121014753400e-19 -1.293860301659219281e-03
-1.818043495210274751e-01 -9.007190817685091500e-03 -2.402551503218045559e-01 1.847796302427759385e-01 -9.938961150670896916e-02 7.386239520349628142e-03 2.326136803721345035e-03 -8.435903646308851034e-02 1.282997521063539148e-01 -1.154718706505534001e-02 9.945494300227076742e-03 8.873378281044055349e-01 7.591602557660448447e-02 -1.625961649123994768e-01 1.173207414088498213e-01 6.266676746863464973e-17 4.498866086436804827e-18 -6.440673434049490762e-17 2.523617558813430541e-18 7.280259059295099401e-17 -2.614868822957026297e-18 -6.040326369789107033e-18 -1.383267962885776527e-17 2.904587585709534158e-17 1.836904424826043866e-17 -2.081488440726437077e-18 7.421710210476129970e-18 2.280380077392488280e-18 5.105515767333616716e-18 3.458233730672574163e-17 -9.547106679772759552e-18 -8.898809209667724041e-02
-1.743519813412401920e-01 1.796188250352649951e-01 2.183404828202011871e-01 1.211028400045850717e-01 -8.474396675603855511e-02 3.423171908781276473e-02 -4.962602578351746688e-03 4.708053377815373669e-02 1.408544963651169914e-02 -8.480414527925372870e-02 1.191755184619746472e-01 -1.157449633367137048e-01 -5.057884452828247390e-01 -7.242406276176930335e-01 1.989723566775770947e-01 -6.192404666021533952e-17 -1.772777093142787252e-16 -9.380482238865703878e-17 4.100841743380826038e-17 -2.523965662003188615e-17 5.692607393604470272e-18 -4.493644052018007289e-17 3.808632778425328385e-17 1.868415769423690302e-19 1.144300713710630133e-18 -8.953771168166879067e-18 1.140082442818893929e-17 2.981857512571958615e-17 4.369696529255880533e-18 -1.045565523497056314e-17 8.832618564630074847e-18 9.736100317651166791e-02
-1.824653779736834514e-01 -2.776319038810023399e-01 1.102574590688917278e-01 -4.970115197862624151e-02 -2.798735159859205845e-02 -1.265883383625531766e-01 2.432735682576644271e-02 1.186929452791667949e-01 8.402799903749344490e-02 4.537596989717342100e-02 -2.453212759069873031e-02 -1.730941201971085697e-01 7.516503557429825566e-01 -4.379842288500793712e-01 2.157853490776692473e-01 6.380672051943874981e-16 -2.845880707808713299e-16 -1.085779003969105842e-16 -7.266460382461843022e-17 -2.527987857801747099e-19 1.190560787058910644e-17 -3.478385839585442738e-17 -3.378364707585899977e-17 1.839286962414202265e-17 -3.691640438574944957e-18 1.345507343822740402e-17 -2.776750600488446622e-17 -1.356977046905280234e-18 -5.797652199714243577e-19 -8.642878699780732314e-18 5.839238321760742058e-19 2.138745679409390088e-02
-1.680920906483728272e-01 1.248057456767704410e-01 -8.630289117613801353e-02 -2.715149827949908112e-01 -3.743825668554183472e-03 -2.462048581550969895e-02 -1.312832214345550641e-01 1.971001919491557897e-02 9.465352886409570538e-03 -1.201060555498949939e-01 -9.437150771202670874e-02 -5.105331687228342047e-02 -8.227929097784279777e-02 3.009005634352394098e-01 8.563970232142392724e-01 2.685012756879619783e-15 1.782300100615383117e-16 2.674121724856862608e-17 6.978591439845478667e-17 -5.232862065594637230e-18 5.983647879020766843e-17 -1.407568420892305137e-17 4.877182439989952532e-18 -3.137190241108180025e-17 6.515032251940067282e-19 8.955129587157675814e-18 -1.585319104920283343e-17 -2.907808400684912020e-18 5.090814687165692801e-18 -1.089830950766515264e-17 1.804912176417270844e-18 -1.293860301659219281e-03
-1.818043495210274751e-01 -9.007190817685091500e-03 -2.402551503218045559e-01 1.847796302427759385e-01 -9.938961150670896916e-02 7.386239520349628142e-03 2.326136803721345035e-03 -8.435903646308867687e-02 1.282997521063538038e-01 -1.154718706505454898e-02 9.945494300228991877e-03 -1.774675656208811736e-01 -1.518320511532128894e-02 3.251923298247925975e-02 -2.346414828177248099e-02 8.838292578565566382e-01 -1.102414602591949983e-01 7.743051985258860015e-02 2.640412831369853136e-02 1.153782527582323181e-16 -2.860802866666660296e-17 3.809669668698571049e-18 3.264890873511987122e-18 8.255349260551976540e-17 3.055323609835447147e-17 1.678454546748411844e-17 3.028963229789172578e-18 2.152475222478846024e-17 2.640762439384764331e-18 1.899540142696770565e-17 -8.217371591637933010e-18 -8.898809209667724041e-02
-1.743519813412401920e-01 1.796188250352649951e-01 2.183404828202011871e-01 1.211028400045850717e-01 -8.474396675603855511e-02 3.423171908781276473e-02 -4.962602578351746688e-03 4.708053377815373669e-02 1.408544963651156036e-02 -8.480414527925389523e-02 1.191755184619745361e-01 2.314899266734291722e-02 1.011576890565649284e-01 1.448481255235384846e-01 -3.979447133551556465e-02 2.268586118620539299e-02 6.308549490296632145e-01 5.118662293405916719e-01 3.734974541381325119e-01 1.521059509355893689e-15 1.658392949601627980e-16 9.589903393948464013e-17 -3.431055406550943851e-17 -9.992655459447609992e-19 1.268736446361141067e-17 8.682365344512739170e-18 -1.867721809756028162e-17 -4.320760038082816057e-18 -4.217659993669313371e-17 -1.651384592036638190e-17 -5.846574327164326111e-18 9.736100317651166791e-02
-1.824653779736834514e-01 -2.776319038810023399e-01 1.102574590688917278e-01 -4.970115197862624151e-02 -2.798735159859205845e-02 -1.265883383625531766e-01 2.432735682576644271e-02 1.186929452791667949e-01 8.402799903749344490e-02 4.537596989717342100e-02 -2.453212759069917440e-02 3.461882403942168063e-02 -1.503300711485964780e-01 8.759684577001600192e-02 -4.315706981553343174e-02 -1.320408145405552458e-01 -6.239019537546379723e-01 4.821305414107733278e-01 4.010756991336759114e-01 1.403640247032151270e-15 1.806210709242186085e-16 -1.363613315944299517e-16 -4.569195239112449095e-18 2.867807219818416142e-18 -1.080533490307606760e-17 -4.166477170184468851e-18 -8.491379020398300943e-18 3.398205980338229104e-17 -2.762496429374142804e-17 2.166064590257451265e-17 -1.352780435593944164e-17 2.138745679409390088e-02
-1.680920906483728272e-01 1.248057456767704410e-01 -8.630289117613801353e-02 -2.715149827949908112e-01 -3.743825668554183472e-03 -2.462048581550969895e-02 -1.312832214345550641e-01 1.971001919491557897e-02 9.465352886409570538e-03 -1.201060555498949939e-01 -9.437150771202687527e-02 1.021066337445636872e-02 1.645585819556855470e-02 -6.018011268704786393e-02 -1.712794046428478545e-01 2.994023971906275075e-02 2.480334303772379484e-02 -5.473094361464612145e-01 7.063573864020683546e-01 6.460615346441654843e-15 -6.201459294421744372e-17 -1.368802779149616591e-16 -2.043822148100292891e-18 9.753354001634110114e-18 -4.559069613551251928e-18 -3.819747408813998429e-17 -1.278237456552244936e-17 -1.131810447759365707e-17 1.661277961920937042e-17 -5.867496676544438181e-18 3.891863427768185575e-18 -1.293860301659219281e-03
-1.818043495210274751e-01 -9.007190817685091500e-03 -2.402551503218045559e-01 1.847796302427759385e-01 -9.938961150670896916e-02 7.386239520349628142e-03 2.326136803721345035e-03 -8.435903646308867687e-02 1.282997521063538038e-01 -1.154718706505454898e-02 9.945494300228991877e-03 -1.774675656208810626e-01 -1.518320511532078934e-02 3.251923298248000915e-02 -2.346414828176933073e-02 -2.209573144641391873e-01 2.756036506479845813e-02 -1.935762996314514817e-02 -6.601032078430046045e-03 7.719540910126817534e-01 -2.005598516378671592e-01 3.260382551035887477e-01 8.695794091851609398e-02 1.124138969198110710e-16 -1.374552725788208473e-17 2.487550084440115941e-17 -2.310491332568247199e-17 4.875733321833905651e-18 1.988197096089548981e-17 1.060502406411227502e-17 -5.989215575203887936e-18 -8.898809209667724041e-02
-1.743519813412401920e-01 1.796188250352649951e-01 2.183404828202011871e-01 1.211028400045850717e-01 -8.474396675603855511e-02 3.423171908781276473e-02 -4.962602578351746688e-03 4.708053377815373669e-02 1.408544963651156036e-02 -8.480414527925389523e-02 1.191755184619745361e-01 2.314899266734291722e-02 1.011576890565649839e-01 1.448481255235385956e-01 -3.979447133551539811e-02 -5.671465296551343044e-03 -1.577137372574158591e-01 -1.279665573351468633e-01 -9.337436353453602844e-02 3.852637241515864397e-01 2.560421940443931010e-01 -6.876656590005449932e-01 -2.512572370164284918e-01 -2.965001629370078457e-16 -9.073300479228662049e-18 -3.116892456008189160e-17 3.417544199978409736e-17 -6.231753434839304808e-17 -7.953923800142932004e-18 2.428342097870039378e-17 -8.223445804226379612e-18 9.736100317651166791e-02
-1.824653779736834514e-01 -2.776319038810023399e-01 1.102574590688917278e-01 -4.970115197862624151e-02 -2.798735159859205845e-02 -1.265883383625531766e-01 2.432735682576644271e-02 1.186929452791667949e-01 8.402799903749344490e-02 4.537596989717342100e-02 -2.453212759069917440e-02 3.461882403942168063e-02 -1.503300711485964780e-01 8.759684577001583539e-02 -4.315706981553393135e-02 3.301020363513867267e-02 1.559754884386595486e-01 -1.205326353526931793e-01 -1.002689247834195468e-01 7.468036445853323824e-02 7.061056680366230021e-01 1.299157614073092881e-01 4.784971511606461170e-01 3.529264775882837323e-16 -9.501850722666477347e-17 -1.073639933779484505e-16 -5.477238165373897754e-17 8.920708609560296941e-18 -6.400318719198246565e-17 -9.665222341877397345e-18 2.006381361030958029e-17 2.138745679409390088e-02
-1.680920906483728272e-01 1.248057456767704410e-01 -8.630289117613801353e-02 -2.715149827949908112e-01 -3.743825668554183472e-03 -2.462048581550969895e-02 -1.312832214345550641e-01 1.971001919491557897e-02 9.465352886409570538e-03 -1.201060555498949939e-01 -9.437150771202687527e-02 1.021066337445636872e-02 1.645585819556855470e-02 -6.018011268704786393e-02 -1.712794046428478545e-01 -7.485059929766361628e-03 -6.200835759430996415e-03 1.368273590366153036e-01 -1.765893466005171719e-01 -9.032573607498206592e-03 -3.816188233649968065e-01 -3.923479228673353303e-01 6.710801693458302575e-01 -2.391012759497744559e-15 -5.613083381766037524e-17 -2.384880917389491946e-17 6.308081735028533764e-17 -3.225679596465862821e-18 1.060408764320255607e-17 -5.240780952317065988e-18 -3.295476161763728706e-19 -1.293860301659219281e-03
-1.818043495210274751e-01 -9.007190817685091500e-03 -2.402551503218045559e-01 1.847796302427759385e-01 -9.938961150670896916e-02 7.386239520349628142e-03 2.326136803721345035e-03 -8.435903646308867687e-02 1.282997521063538038e-01 -1.154718706505454898e-02 9.945494300228991877e-03 -1.774675656208810626e-01 -1.518320511532078934e-02 3.251923298248000915e-02 -2.346414828176933073e-02 -2.209573144641391873e-01 2.756036506479884671e-02 -1.935762996314778495e-02 -6.601032078422829595e-03 -2.573180303375607325e-01 6.685328387928796134e-02 -1.086794183678641695e-01 -2.898598030617058341e-02 7.859483401671333302e-01 2.151058263647540325e-01 5.463806086290629027e-03 -5.149275232673504454e-02 -1.748541538383273878e-15 -3.542717333978401142e-18 7.179724971450750885e-17 -9.728741009000033664e-18 -8.898809209667724041e-02
-1.743519813412401920e-01 1.796188250352649951e-01 2.183404828202011871e-01 1.211028400045850717e-01 -8.474396675603855511e-02 3.423171908781276473e-02 -4.962602578351746688e-03 4.708053377815373669e-02 1.408544963651156036e-02 -8.480414527925389523e-02 1.191755184619745361e-01 2.314899266734291722e-02 1.011576890565649839e-01 1.448481255235385956e-01 -3.979447133551539811e-02 -5.671465296551343044e-03 -1.577137372574157481e-01 -1.279665573351482510e-01 -9.337436353453219817e-02 -1.284212413838626277e-01 -8.534739801479777899e-02 2.292218863335154788e-01 8.375241233880920122e-02 -2.143514818390850063e-01 7.764904650778426953e-01 1.326228170599364486e-01 -1.392317989317335379e-02 -2.985457126734987864e-16 -7.869481999268643127e-17 1.145106812887966838e-16 7.452647187640300819e-18 9.736100317651166791e-02
-1.824653779736834514e-01 -2.776319038810023399e-01 1.102574590688917278e-01 -4.970115197862624151e-02 -2.798735159859205845e-02 -1.265883383625531766e-01 2.432735682576644271e-02 1.186929452791667949e-01 8.402799903749344490e-02 4.537596989717342100e-02 -2.453212759069917440e-02 3.461882403942168063e-02 -1.503300711485964780e-01 8.759684577001583539e-02 -4.315706981553393135e-02 3.301020363513867267e-02 1.559754884386595486e-01 -1.205326353526933458e-01 -1.002689247834187697e-01 -2.489345481951156513e-02 -2.353685560122077414e-01 -4.330525380243645250e-02 -1.594990503868819187e-01 1.378570108263609678e-02 -1.312446072360651250e-01 7.637419066074522256e-01 -2.568068812851238003e-01 -9.084961675041569526e-15 -1.331269381956888790e-16 7.735077826400735940e-17 1.851034906595381452e-17 2.138745679409390088e-02
-1.680920906483728272e-01 1.248057456767704410e-01 -8.630289117613801353e-02 -2.715149827949908112e-01 -3.743825668554183472e-03 -2.462048581550969895e-02 -1.312832214345550641e-01 1.971001919491557897e-02 9.465352886409570538e-03 -1.201060555498949939e-01 -9.437150771202687527e-02 1.021066337445636872e-02 1.645585819556855470e-02 -6.018011268704786393e-02 -1.712794046428478545e-01 -7.485059929766361628e-03 -6.200835759430996415e-03 1.368273590366153036e-01 -1.765893466005170609e-01 3.010857869163943538e-03 1.272062744549989355e-01 1.307826409557784897e-01 -2.236933897819435024e-01 5.305911735266099355e-02 -1.528269757765036638e-02 2.564104170590940091e-01 7.732215296477168431e-01 2.577553135868981082e-14 -6.661125476168276136e-17 -4.405956734015492819e-16 -9.288763074844276570e-17 -1.293860301659219281e-03
-1.818043495210274751e-01 -9.007190817685091500e-03 -2.402551503218045559e-01 1.847796302427759385e-01 -9.938961150670896916e-02 7.386239520349628142e-03 2.326136803721345035e-03 -8.435903646308867687e-02 1.282997521063538038e-01 -1.154718706505454898e-02 9.945494300228991877e-03 -1.774675656208810626e-01 -1.518320511532078934e-02 3.251923298248000915e-02 -2.346414828176933073e-02 -2.209573144641391873e-01 2.756036506479884671e-02 -1.935762996314778495e-02 -6.601032078422829595e-03 -2.573180303375606215e-01 6.685328387928962668e-02 -1.086794183678622822e-01 -2.898598030617277610e-02 -3.929741700835667206e-01 -1.075529131823771412e-01 -2.731903043145022213e-03 2.574637616335109444e-02 4.979996487014350937e-01 1.821501870104978715e-02 4.998012886550776690e-01 -4.316520410807792724e-02 -8.898809209667724041e-02
-1.743519813412401920e-01 1.796188250352649951e-01 2.183404828202011871e-01 1.211028400045850717e-01 -8.474396675603855511e-02 3.423171908781276473e-02 -4.962602578351746688e-03 4.708053377815373669e-02 1.408544963651156036e-02 -8.480414527925389523e-02 1.191755184619745361e-01 2.314899266734291722e-02 1.011576890565649839e-01 1.448481255235385956e-01 -3.979447133551539811e-02 -5.671465296551343044e-03 -1.577137372574157481e-01 -1.279665573351482510e-01 -9.337436353453219817e-02 -1.284212413838626277e-01 -8.534739801479775123e-02 2.292218863335147572e-01 8.375241233880964531e-02 1.071757409195426697e-01 -3.882452325389213477e-01 -6.631140852996844637e-02 6.961589946602531401e-03 -4.655892209054302566e-01 2.791699590398675768e-01 4.477420262772628945e-01 -6.941101678756579629e-02 9.736100317651166791e-02
-1.824653779736834514e-01 -2.776319038810023399e-01 1.102574590688917278e-01 -4.970115197862624151e-02 -2.798735159859205845e-02 -1.265883383625531766e-01 2.432735682576644271e-02 1.186929452791667949e-01 8.402799903749344490e-02 4.537596989717342100e-02 -2.453212759069917440e-02 3.461882403942168063e-02 -1.503300711485964780e-01 8.759684577001583539e-02 -4.315706981553393135e-02 3.301020363513867267e-02 1.559754884386595486e-01 -1.205326353526933458e-01 -1.002689247834187697e-01 -2.489345481951156513e-02 -2.353685560122077414e-01 -4.330525380243634148e-02 -1.594990503868820853e-01 -6.892850541318256558e-03 6.562230361803260414e-02 -3.818709533037260573e-01 1.284034406425682839e-01 -1.876777163475124577e-01 -6.443666122095044191e-01 2.153613581957642131e-01 5.646440695077557803e-02 2.138745679409390088e-02
-1.680920906483728272e-01 1.248057456767704410e-01 -8.630289117613801353e-02 -2.715149827949908112e-01 -3.743825668554183472e-03 -2.462048581550969895e-02 -1.312832214345550641e-01 1.971001919491557897e-02 9.465352886409570538e-03 -1.201060555498949939e-01 -9.437150771202687527e-02 1.021066337445636872e-02 1.645585819556855470e-02 -6.018011268704786393e-02 -1.712794046428478545e-01 -7.485059929766361628e-03 -6.200835759430996415e-03 1.368273590366153036e-01 -1.765893466005170609e-01 3.010857869163943538e-03 1.272062744549989355e-01 1.307826409557784897e-01 -2.236933897819433914e-01 -2.652955867632928247e-02 7.641348788825210077e-03 -1.282052085295469768e-01 -3.866107648238584771e-01 -3.194628357451682324e-04 8.077138189386924572e-02 5.783800791806292113e-02 7.000933128165998109e-01 -1.293860301659219281e-03
-1.818043495210274751e-01 -9.007190817685091500e-03 -2.402551503218045559e-01 1.847796302427759385e-01 -9.938961150670896916e-02 7.386239520349628142e-03 2.326136803721345035e-03 -8.435903646308867687e-02 1.282997521063538038e-01 -1.154718706505454898e-02 9.945494300228991877e-03 -1.774675656208810626e-01 -1.518320511532078934e-02 3.251923298248000915e-02 -2.346414828176933073e-02 -2.209573144641391873e-01 2.756036506479884671e-02 -1.935762996314778495e-02 -6.601032078422829595e-03 -2.573180303375606215e-01 6.685328387928962668e-02 -1.086794183678622822e-01 -2.898598030617277610e-02 -3.929741700835668317e-01 -1.075529131823769191e-01 -2.731903043145632835e-03 2.574637616338395704e-02 -4.979996487014333728e-01 -1.821501870104976634e-02 -4.998012886550777800e-01 4.316520410807789254e-02 -8.898809209667724041e-02
-1.743519813412401920e-01 1.796188250352649951e-01 2.183404828202011871e-01 1.211028400045850717e-01 -8.474396675603855511e-02 3.423171908781276473e-02 -4.962602578351746688e-03 4.708053377815373669e-02 1.408544963651156036e-02 -8.480414527925389523e-02 1.191755184619745361e-01 2.314899266734291722e-02 1.011576890565649839e-01 1.448481255235385956e-01 -3.979447133551539811e-02 -5.671465296551343044e-03 -1.577137372574157481e-01 -1.279665573351482510e-01 -9.337436353453219817e-02 -1.284212413838626277e-01 -8.534739801479775123e-02 2.292218863335147572e-01 8.375241233880964531e-02 1.071757409195426697e-01 -3.882452325389213477e-01 -6.631140852996794677e-02 6.961589946570779022e-03 4.655892209054305897e-01 -2.791699590398674657e-01 -4.477420262772630055e-01 6.941101678756581017e-02 9.736100317651166791e-02
-1.824653779736834514e-01 -2.776319038810023399e-01 1.102574590688917278e-01 -4.970115197862624151e-02 -2.798735159859205845e-02 -1.265883383625531766e-01 2.432735682576644271e-02 1.186929452791667949e-01 8.402799903749344490e-02 4.537596989717342100e-02 -2.453212759069917440e-02 3.461882403942168063e-02 -1.503300711485964780e-01 8.759684577001583539e-02 -4.315706981553393135e-02 3.301020363513867267e-02 1.559754884386595486e-01 -1.205326353526933458e-01 -1.002689247834187697e-01 -2.489345481951156513e-02 -2.353685560122077414e-01 -4.330525380243634148e-02 -1.594990503868820853e-01 -6.892850541318256558e-03 6.562230361803260414e-02 -3.818709533037260573e-01 1.284034406425555719e-01 1.876777163475215060e-01 6.443666122095046411e-01 -2.153613581957642964e-01 -5.646440695077560579e-02 2.138745679409390088e-02
-1.680920906483728272e-01 1.248057456767704410e-01 -8.630289117613801353e-02 -2.715149827949908112e-01 -3.743825668554183472e-03 -2.462048581550969895e-02 -1.312832214345550641e-01 1.971001919491557897e-02 9.465352886409570538e-03 -1.201060555498949939e-01 -9.437150771202687527e-02 1.021066337445636872e-02 1.645585819556855470e-02 -6.018011268704786393e-02 -1.712794046428478545e-01 -7.485059929766361628e-03 -6.200835759430996415e-03 1.368273590366153036e-01 -1.765893466005170609e-01 3.010857869163943538e-03 1.272062744549989355e-01 1.307826409557784897e-01 -2.236933897819433914e-01 -2.652955867632928247e-02 7.641348788825210077e-03 -1.282052085295469768e-01 -3.866107648238583661e-01 3.194628357193878563e-04 -8.077138189386919020e-02 -5.783800791806247704e-02 -7.000933128165996999e-01 -1.293860301659219281e-03
"""
        fd = io.StringIO(U_wm_txt)
        U_wm = np.loadtxt(fd)

        V_wm_txt = """-1.259389094644439988e-01 -2.514461446193460015e-01 -1.553259298168772062e-01 -2.742849290984701316e-01 -1.200137845033524830e-01 -1.244889760703769416e-01 -1.685014363446087071e-01 -1.366989543656035866e-01 -1.361744671006094032e-01 -1.596878276413938591e-01 -1.473698295963598026e-01 -1.783745658116902832e-01 -1.253012345555033491e-01 -2.199261102788062083e-01 -1.525085402543156499e-01 -1.542963571340920381e-01 -1.527293916889542191e-01 -1.913432691063478575e-01 -5.615364626562357325e-02 -1.692258450976459883e-01 -1.679066831528461812e-01 -1.373550254892388911e-01 -1.790375675381779552e-01 -2.157765755463837420e-01 -1.721751687100862849e-01 -2.871789938520589724e-01 -2.657627322720333973e-01 -1.735792513483107313e-01 -2.203976825749955071e-01 -1.581008728403302255e-01 -1.347537090032501494e-01 -1.177078912421575668e-01
-1.115771960887423364e-01 -1.063625329365843475e-01 -1.972075713365369076e-01 8.691068886236236191e-02 -3.171474764034765692e-01 1.308536759024794272e-01 -3.024552391309428545e-01 2.021596703310456211e-01 -1.406609937036313596e-01 6.027918790421413209e-02 -1.114068589611684618e-01 5.367230434919214449e-02 1.710668862270076640e-01 -4.693382592054023972e-02 -1.635106509927259921e-01 2.573641125437640675e-01 -1.150151235595041205e-01 3.405884813214402063e-01 -2.588673140222838912e-02 2.143695168666141793e-01 1.135186901020685812e-01 1.187729025727448512e-01 -1.370568323046633674e-01 3.239350141740668376e-01 -1.084596693836058223e-01 8.888787635792771979e-02 -1.183007708614525200e-01 -1.831388885127847310e-01 8.834437272784642636e-04 -2.554002479992613095e-01 2.154207682218183539e-01 -1.057796326054943059e-01
1.485587161187615357e-01 -5.174624401947800628e-02 2.651765824627919654e-01 -7.339223477095493942e-02 -1.209383347127136882e-01 1.160775239920150831e-01 8.435384923960177750e-02 -4.829005053861992747e-02 1.357070209269707062e-01 -3.769247395369049181e-01 -1.909200541740939949e-01 -1.585315304287193972e-01 1.654224616618327759e-01 3.502164853882942519e-01 1.199418485069123214e-01 3.450681470689387353e-02 2.385209431841231187e-01 1.615130053756359263e-01 -1.084383981306931283e-01 5.454974139552257878e-02 1.475754406676749175e-01 -4.239354705628889386e-01 -2.536380168739337249e-01 -9.967932364473068574e-02 -1.923625822313542247e-02 -1.025334330198872379e-01 -1.088477933775158640e-01 3.993183820521987309e-02 6.244226897101634588e-02 -2.127076356457779580e-02 2.360339518507933443e-01 -1.283176144870794844e-01
4.770278258571021557e-02 2.011525065461359785e-01 8.147512361403405623e-02 -1.289884448815891704e-01 1.822360126363839483e-01 1.129571593560422665e-01 9.474641533710964625e-02 2.005947577543213400e-01 -1.448542672339174775e-01 -1.799811268900874672e-01 -3.039546420256039050e-01 -2.514740202186617202e-01 1.582789515807574848e-03 -4.017178095220406697e-01 -2.196379022296652272e-01 -1.076898716350235818e-01 -7.236363358457946482e-02 -7.504851122679867537e-02 -4.392834557270158813e-02 2.090792933617497129e-01 1.354005747164398477e-01 7.354441329524730175e-02 -6.509860229913230767e-02 3.663457458695989349e-03 3.995114827032402172e-01 2.109315840579266410e-02 -8.990272300909545045e-02 -1.286302127865612821e-01 9.372059260846582474e-02 1.867122381145659982e-01 2.056128472792731476e-01 2.312359887866199670e-01
0.000000000000000000e+00 3.750164016490477592e-01 2.366062612205762083e-01 2.265841189033626635e-01 2.050742318999014269e-01 -4.108740961615837128e-01 -6.528609243348475200e-02 -3.849259764253385591e-02 -2.180605693483889385e-01 -9.253996273378375936e-02 4.896829629131067146e-02 -3.575095705584270533e-02 1.862386191862610285e-01 7.070630496408863985e-02 -9.701853840029991960e-02 5.843093825621344800e-02 1.291167573684160741e-01 2.503836899054864840e-01 2.435825416072551208e-02 4.165394467973325410e-02 -5.841864464500685222e-02 4.169025625510051902e-02 2.877194306930828116e-01 -1.528821096975577776e-01 -1.984655546409951760e-02 -1.247629204911878259e-01 -1.928114558041041371e-01 -3.241345197284902779e-01 -2.072834473606023631e-01 -1.287938192755332112e-01 -3.946332454174904247e-02 -1.039873118040800237e-01
0.000000000000000000e+00 6.322707465092486379e-02 -4.350000326404500350e-02 -1.868430617136463967e-01 -2.990065367621729253e-01 5.192860869993559669e-02 -2.312817260030168853e-01 -4.802288108007488066e-02 1.174407818643884022e-01 -4.055088904404177130e-01 1.486138622439984180e-01 8.154617001183570024e-02 4.211956179339704232e-02 1.044280105575126349e-01 -1.068613542180317233e-01 2.697490339002467374e-02 2.093769489834008124e-01 -1.322988012237806543e-01 -1.282083525696187110e-01 -1.276481541230137795e-01 -2.050728453830261699e-01 4.205444616422031046e-01 1.185966711964119985e-01 -2.644270540799057434e-01 3.855785847661755139e-02 2.903174898797719061e-01 9.844464673724440118e-02 -1.764634765430027064e-01 6.282621883206354618e-02 1.272370955926249991e-01 1.872984046039217476e-01 2.678966273671243292e-02
0.000000000000000000e+00 1.715309330532311383e-01 1.096520315029076223e-02 -1.235444635050899076e-01 -1.645295543501312241e-01 -3.047027332265086486e-01 2.406416965619311704e-03 -4.312347649117592718e-02 -1.887410455812847110e-01 2.027863107362249395e-01 3.275235678391156813e-01 5.433782055203039557e-02 -3.124575479361328956e-01 -4.131327993049456471e-02 -2.540959271817084045e-02 -1.806217223845262287e-01 1.355488743162075738e-01 -6.842045174868274099e-03 1.032148873635014980e-01 2.713724366081508022e-01 3.163831021233874385e-01 1.550658213813382869e-02 -3.284635399969637604e-01 -2.033203104331640643e-01 -2.011659485472484243e-01 8.214550610693689692e-02 -7.441503185188239056e-02 8.285097055362103391e-02 2.878684098705740560e-02 1.073246279861927166e-01 2.981052373389766474e-01 -2.690934776651702359e-02
0.000000000000000000e+00 -4.807241679532606171e-02 -3.014315940429705964e-01 6.298615950621760592e-03 2.855491376824243477e-01 -2.289674448531899345e-04 -1.203681988789624263e-01 5.532612270758604373e-02 7.650326341740393277e-02 6.223900056380398532e-02 8.925157265257555039e-02 6.879149332386917670e-02 1.301199002138843930e-01 4.285382275179324130e-01 -3.307693093296756870e-01 -1.618897047197550287e-01 1.219877248534775582e-01 -1.893579423058989464e-01 5.454663848806651227e-02 2.276180026244758667e-02 1.657677151231041479e-01 -6.501559169340789812e-02 -1.616302686440974912e-01 -9.660127889989410244e-02 2.117853086662767337e-01 5.500533955703699324e-02 -4.264698835928895648e-02 -5.971981289338808285e-02 -5.043719210283938853e-02 -3.801678593451928712e-01 -3.575358523770444386e-02 3.550725412083494126e-01
0.000000000000000000e+00 7.332792538351501355e-02 -5.583452982190802161e-02 8.506422736631449877e-02 -6.365907869446381720e-03 4.451063564870083589e-01 2.626441755655633536e-01 -6.684936796797452674e-02 -6.353757777215754965e-01 -1.878673308758495031e-01 1.152455258956886636e-01 3.380065797257553878e-02 8.006402779040670825e-02 3.041915327347163162e-02 7.568885293433193218e-02 -5.738575047060524847e-02 4.104827885069251003e-02 7.704573966416165820e-02 5.158203736938230671e-02 4.666560268217107010e-02 -1.403095432419269317e-01 1.739863575107093718e-01 -9.186213104100217353e-02 -1.963898541018935240e-01 -7.681320750714015766e-02 -7.299572694673095441e-02 5.105036955466241144e-02 2.421472911604800049e-01 -8.584503571660228108e-03 -2.267788342617655939e-01 -8.467609047801637201e-02 4.809434935365723002e-02
0.000000000000000000e+00 -9.989498778236709231e-02 2.407838784347668404e-02 1.776017439073902804e-02 1.011594999373286452e-01 3.762385093758418564e-01 -9.294474985814380266e-03 -2.819123579253246872e-02 1.301714691292867564e-02 1.897803079428602158e-01 -5.176993668592237696e-02 -1.144205824227729207e-01 -4.645687548698759217e-01 1.673304191663322060e-01 3.964440957083563422e-02 7.844689187141463960e-02 1.145283978026060967e-01 -3.781695514025342625e-02 -1.065343968763698967e-01 -1.817193426772540157e-02 2.407826635500592283e-01 1.484618626570496924e-01 3.444519791034089118e-01 -9.421598883389742385e-02 -6.959694997905610525e-02 -3.474438253250585196e-01 5.748495581468987536e-02 -2.945068438838200908e-01 -7.035425243408433005e-02 -6.785990100904798483e-02 2.701958315462606453e-01 -3.194803385803413054e-02
0.000000000000000000e+00 8.223655116855852973e-03 -1.318311823362431356e-01 7.001188538583415222e-02 1.312696813688667696e-01 -1.524870959930788306e-01 4.329463273372732152e-02 7.427206735701950835e-02 1.843019156610520293e-02 -1.794951470339063992e-01 1.426858205664953971e-01 -6.382101534612141802e-02 1.641868924086203885e-01 6.025985767970068463e-02 3.847239456577295491e-01 4.532578349216093844e-02 -1.197638729863586410e-01 -1.320762923964747815e-01 -2.806857587264467435e-01 -1.072986593941260836e-01 3.512433196407406255e-01 4.168782099262589025e-01 -3.430771995912059724e-01 1.297656296126750985e-01 1.153601401572725976e-01 -2.441753614790675431e-01 4.863563199335352999e-02 -9.237049910445922773e-02 -1.365095717759144123e-01 6.631200989074917396e-02 -9.359288943719451526e-02 -1.507509971946341121e-01
0.000000000000000000e+00 -1.118457629079932653e-01 -6.302218229679914033e-03 -1.815242004429608869e-01 -2.106187797719655530e-01 -1.593504702700720421e-01 4.284854507903684273e-01 -3.337882407845145227e-01 1.918748777244519421e-01 -3.098021234707864363e-02 8.862295775533722553e-02 -8.597735233064719707e-02 6.745915632348889468e-02 -7.390143967136761360e-02 -2.022436119098457719e-01 -1.491654518132095597e-01 1.675120516064074749e-01 1.137869645624956655e-01 -2.322302518734964127e-01 2.217230038857564423e-01 2.438497315019717837e-02 2.333746199977215774e-01 2.116537766477434024e-01 3.072557051443940979e-01 3.124360494423405674e-02 -1.531095801064016049e-01 -1.069979881589153692e-01 1.419091961635561006e-01 -7.416997071534665170e-03 -2.375692996268989055e-01 -2.474982027995389217e-02 1.098726842653984237e-01
0.000000000000000000e+00 -2.286428629969450843e-01 4.814583552173457570e-01 2.920930299492011800e-02 1.579531967063289855e-01 2.654089505264593807e-02 -1.075963879128913614e-01 -3.387214501919536547e-01 -1.111552716377085387e-01 7.737586312164550228e-02 2.601867095591104961e-01 -5.347641802926173665e-02 2.524247023890048292e-01 -2.052938804621688429e-01 -8.306650356307170024e-02 1.426393895279916835e-01 -8.801244733689769784e-02 -1.994645598361367289e-01 3.224114712442752856e-02 -2.047591238209242326e-01 5.025359516868891513e-02 -8.459620354393342090e-03 -1.398021174879154060e-01 1.255520985927169875e-01 -1.147745546693254570e-01 1.864915026362835154e-02 1.629753117868857903e-01 -1.529188227290391167e-01 1.615961045045420097e-01 -1.527775368656543731e-01 2.547046868833112709e-01 1.868077986838997673e-01
0.000000000000000000e+00 5.835892713136199041e-03 1.637045083306306603e-01 -1.005177202230352479e-01 3.741447030434290333e-02 -8.525250555585997536e-02 1.755331652575267687e-01 -9.540407808649269822e-03 2.057710373539275439e-01 1.503679660060993351e-01 -3.209498694448353340e-01 -3.583397252589469451e-02 -5.138884188440329126e-02 1.988561622500829573e-01 1.307461162968768902e-02 5.489608773641245498e-02 -7.137299075039101048e-02 1.630155572778815842e-01 4.398429584409218607e-01 2.663372786249885646e-02 -3.194560342869920966e-01 4.249789643412700268e-01 -3.663351563361855745e-01 -8.189952725720356375e-02 -6.090895560885617455e-02 -1.576957193359491416e-01 6.869505722178492757e-02 -1.007036453416833705e-01 1.133238286838619997e-02 -4.063944826848769204e-02 6.221371315959480647e-02 1.018908470621541912e-01
0.000000000000000000e+00 1.849464508521501682e-01 -2.197215316295000054e-01 -2.208791465066732851e-01 1.630624688650514909e-01 -1.998548849292531293e-01 3.588337127082452671e-02 -3.436747254021619291e-01 -2.210635971854158222e-01 -5.322655865810738129e-02 -3.729048723908331420e-01 3.456723476284263019e-01 -9.581681238692164870e-02 1.334311182686719610e-01 4.683804270499826450e-02 7.039787713499662258e-02 -2.017587762610851820e-01 1.429911117540517140e-01 -3.082301138909653293e-01 -1.076238956409545922e-01 2.155256439536702012e-02 -1.020841979352186402e-01 2.660619308421544732e-03 8.267354028512406694e-02 -1.317994804303730116e-01 5.218055419558483010e-02 2.463770303456145894e-01 -5.193520602199491742e-02 1.144076766241211851e-01 4.141745062248611275e-02 1.572298026249466241e-01 1.729924563402230608e-01
0.000000000000000000e+00 2.707073784729244897e-02 -2.705981401515445417e-01 -3.681503416745101481e-02 7.122391036335454229e-02 -1.365588577324041153e-01 -2.063130243416986809e-01 -9.941952298031667135e-02 -2.093058771326293532e-01 1.663011120884891059e-01 -3.334743366686673122e-02 -5.357591826708000271e-01 1.461123304424770952e-01 1.835039153406956280e-01 1.245895048372359509e-01 1.387613958878639586e-01 1.856620830013498424e-01 -1.490941900594310587e-01 3.431346457538960587e-02 -5.846509883051229095e-03 -2.543201058173696905e-01 2.542359747624707914e-02 9.631645157007512337e-02 2.004161133715004761e-01 -2.015222912027628613e-02 -5.784372084012817661e-02 -5.577419450781755106e-02 2.920519821273927508e-01 -5.532851368758706645e-02 2.037284311410329507e-01 2.907817497490749470e-01 7.173535328673030786e-02
0.000000000000000000e+00 3.267110738391968416e-01 -8.757689730568260500e-02 1.784339962261448087e-01 -5.483091670765171538e-02 1.644088759704356584e-01 -6.954922089000808993e-03 -3.622244076266964985e-01 2.386490391849125925e-01 2.473416232795278558e-01 -1.718921071197496847e-02 -4.201932353243721663e-02 -1.821057411235602747e-02 -1.337001277394321841e-01 1.160687864367776490e-01 3.654945873414008894e-01 -7.194626229037760778e-02 -1.535914396455191067e-01 -2.603855154262957328e-01 1.836089709928943603e-01 -1.384456770623934685e-01 -3.084269468394564354e-02 -1.861777420418831153e-01 -2.865530857133893328e-01 1.665930647268415166e-01 7.758495804206658186e-02 -2.551399027297561739e-01 3.569006883995730350e-03 7.284932042755878911e-02 -1.807579356491635370e-01 -4.094279644451426919e-02 -3.592510777596315263e-02
0.000000000000000000e+00 -2.282404087943374071e-01 2.348410307095222804e-01 -8.445168734930902366e-02 1.365603876199066868e-01 -5.218639292676472557e-02 -4.071315937500273596e-02 2.911804070239766840e-01 -8.010812075510823083e-02 9.815598104898254350e-02 1.719209666618308485e-01 -2.874599650154225153e-02 -8.273162983530590875e-02 1.855787127672734182e-01 4.365927928975028849e-02 -3.292786055922874988e-02 -1.301037768629676461e-01 1.760286681725903302e-02 -5.057961371208906654e-01 4.396397890084739468e-01 -4.069477026341954407e-01 -3.588182565600134266e-02 -8.397057746456984550e-02 -3.400487710446708362e-02 -5.739022472674246839e-02 2.001907132500100467e-02 8.585880675358029124e-02 -1.047578935346168694e-01 -1.415577187360517533e-02 6.252274738081758931e-02 -7.805544226138801112e-02 1.157808726592527565e-01
0.000000000000000000e+00 3.315822907000808284e-01 -1.475472918733492650e-02 -2.027272329889542868e-03 -1.418768714858455182e-02 2.131274101707574670e-02 2.274111648841819766e-01 1.961810727136382992e-01 1.142629085636609823e-02 -6.866486670585023044e-02 2.893246010175446470e-01 -1.976068178278738430e-01 -3.474685024683870638e-01 8.995582376797822688e-02 -2.899988551447661989e-01 1.379571893342413924e-01 -4.444329326046497081e-02 8.320750219658755442e-02 -1.238357430554005989e-01 -4.363731430155723956e-01 -2.020257804685678948e-01 -1.210281577407778669e-01 -2.190226993073005612e-01 3.045180647134140273e-01 3.420111182424788454e-02 1.754098391062777762e-02 1.803738440640245688e-03 -6.012864509537126784e-02 7.898620098025685432e-02 -9.648171179000562814e-02 3.298072814721570573e-02 -8.283207200166398110e-02
0.000000000000000000e+00 -3.707927438040244106e-02 -1.607114268021743730e-01 -7.784950366679183054e-02 1.155901158997242606e-02 -4.929999533108023191e-02 1.883726845234263148e-01 1.781317871645559658e-01 -8.750740681504226223e-03 -5.958673614257721518e-02 6.172614140886457934e-02 1.753382429176959800e-01 -4.068282817789800609e-02 -2.099578406893762572e-01 5.181014673855658392e-01 4.439451941054997630e-02 3.425313562833100511e-01 -8.786318060048367573e-02 1.145978778699188322e-01 -3.465377764968475410e-02 -1.737227044183182745e-01 -1.428787755453236052e-01 3.036243231861198745e-03 1.595005969968338044e-01 -6.355822769280705664e-02 6.347245212426694261e-02 -2.388428928207325386e-01 -3.454830904414339376e-01 3.965388787561083261e-02 -1.697761897746555559e-01 1.096971114357395277e-01 3.167197687508851445e-01
0.000000000000000000e+00 6.961644562013571957e-02 -2.577752929708357899e-01 2.445781445064876825e-01 -2.531174043724332967e-01 5.002715934588216479e-02 2.692341571539339506e-01 -3.638201425153252122e-02 2.558087880415503210e-02 2.142875603048833566e-01 -7.668288411519724214e-03 -1.874455260786266897e-01 3.066221236398126715e-01 -5.550648728440185642e-02 -8.988837186557624426e-02 -2.436453893807124793e-01 7.024180655546020946e-02 -2.396216707360304676e-02 -5.925367656333228872e-02 1.855816459363748144e-02 -5.703169845765927726e-02 -1.772876074824191461e-01 -8.238476325957125312e-02 -1.148378046750448689e-01 -1.147679619733308759e-01 -5.054569615472834232e-02 4.367110200196467895e-01 -4.221367651090233708e-01 -3.788504712907852373e-02 1.772492039033155831e-01 1.905109182348515076e-02 -1.777363967223064348e-02
0.000000000000000000e+00 2.856122610315692256e-01 1.624562320761170908e-01 -1.408690625760473381e-01 -1.860068999688987978e-01 5.918170676495634885e-02 -1.544714214490011117e-01 1.330274909431513886e-01 6.675542486261956676e-02 2.114694757175139550e-01 -4.257263695076828058e-02 -1.512520475991779023e-01 1.334928461306760794e-01 7.074210925517093740e-02 3.086055103753075346e-01 -5.202503780308823655e-01 -3.092137000561110960e-01 5.608749131587819486e-02 -1.126159863471623696e-01 -2.082736146626904539e-01 8.479973192867529264e-03 4.832610473695425624e-02 1.441561644453478730e-01 -2.995339681707893942e-02 -2.347771257760998542e-03 6.782459555777892168e-02 -6.914210810187412792e-02 6.676392474194223214e-02 8.964557186191784988e-02 -3.259324435428254119e-01 1.386477538091546724e-01 6.085202527930753946e-02
0.000000000000000000e+00 -3.879892577727327846e-02 9.652404226878756599e-02 -2.352806523178560261e-01 -1.042567383215747545e-01 -3.875816857234537505e-02 1.212521040352808055e-01 3.057137859984919714e-01 -1.236700901063538249e-01 4.005367019489340374e-01 -1.314814755401184365e-01 1.442225410393926655e-01 2.724980188157305472e-01 -3.056928220638224780e-02 -1.578418058008080604e-01 2.291157824225111272e-01 2.783860744247645957e-01 6.818419618858458445e-03 -2.520547893915872084e-01 -3.350236996097230024e-01 1.192161552175617784e-01 8.433650657508524884e-02 -4.571500728884905600e-03 -2.317645824683060019e-01 -5.576231538159933526e-02 -1.461869277278311507e-01 -1.683830238541677293e-01 1.113206307435734010e-01 1.492516403597781149e-01 1.198762693019891912e-01 -1.082577927497055947e-01 7.004977156457728449e-02
0.000000000000000000e+00 1.041808955496225514e-02 -1.747099805455223365e-01 -4.738131143792287392e-02 1.920211384794943132e-01 1.418007592581745080e-01 -4.509636410526884215e-02 -7.051425594755809934e-02 1.718389440044107985e-01 -1.201288660717743095e-01 1.998875517703723736e-01 -2.831127197160737685e-01 5.772765897237517457e-02 -9.899546961329962202e-03 8.825383031784404548e-04 2.201388308047754275e-02 -1.591862472200782086e-01 3.650062070173995532e-01 2.103199192505416509e-02 -8.607830239543345571e-03 1.530925498959105346e-01 5.006872221567960218e-02 3.327600534409315414e-02 -1.267621437981090449e-01 -4.231372729952884715e-01 3.029225301657577363e-02 -2.337236405077995627e-01 -8.393494702086469472e-02 2.827004860514100160e-01 2.338691375819732521e-01 -2.278068373686995829e-01 3.237326727145261041e-01
0.000000000000000000e+00 -8.577276809610409614e-02 9.644589189385273376e-03 5.620973115597505121e-02 5.360937129277822122e-02 2.021531075326927773e-01 1.618096497230741837e-01 -1.952099867501927433e-01 -9.823592072009594556e-02 1.357661290381478592e-01 6.683483780148263831e-02 2.616403329520760601e-01 1.223205480674081497e-01 2.454246686067201033e-01 -7.843207983214339762e-02 -2.511161970054341941e-01 -1.636759178953444138e-01 -6.859282261517160584e-02 1.485572863491109105e-02 -7.108236402666205656e-02 -1.111502449784396163e-01 4.211710046670236879e-02 -2.575391618221174045e-02 1.785024816639028122e-01 9.516347793445065206e-02 8.177513962951564463e-02 -5.356200102907443528e-01 -1.925085795824716950e-01 -4.229883296516952218e-02 3.943881326007420141e-01 1.558655416068518429e-01 -1.766630884770923338e-01
0.000000000000000000e+00 8.503056057093826003e-02 1.824845739919907506e-01 4.938977445360515084e-01 -1.253466284474680226e-01 -2.479369069727509201e-02 -1.260529600792784366e-01 -2.210931633521534892e-03 -4.458783018829275829e-02 -7.892457796054652697e-02 -3.507427547468651707e-01 -9.220790663109689964e-03 -1.867231734238741503e-01 5.524466135121911675e-02 -8.051505022754504304e-02 -1.910851281540514035e-01 2.213406932425632800e-01 -2.900342060464630722e-01 -1.643320459276707834e-01 -2.115731834762167932e-02 3.714517726779502371e-02 1.429722440924896254e-01 -1.156069506298953997e-01 2.136877103934325395e-01 -3.392903442033967099e-01 6.127949759492767184e-02 -1.236000919794620623e-01 4.973476543884260137e-02 1.204714197868338582e-01 3.070456741303236037e-02 -1.981584487467930311e-01 1.957501010634614125e-01
0.000000000000000000e+00 1.720207337333935216e-01 -1.186535335951746095e-01 1.165416311407443395e-01 2.167545520080225163e-01 1.102097829543589730e-01 -2.084555481066827920e-01 9.511322901389916706e-02 2.619522014683163813e-01 -8.798863555861966002e-02 1.150294088509634660e-01 3.265071588841070849e-01 1.276686526088945395e-01 -2.420810171657920562e-01 -1.151434063571728783e-01 -1.890995908966039418e-01 1.084116691560145229e-01 5.162615083184454723e-02 -7.395520589473501827e-02 3.703942946322441587e-02 -2.308789213112073524e-01 -1.351694079778328894e-02 -7.089643288161294465e-02 2.161387402313810768e-02 -1.523039558053746745e-01 -5.077316676513072835e-01 2.809502572107475116e-02 2.208257596894841746e-01 8.191164184069940624e-02 3.999565037434080900e-02 2.993875518204646147e-01 -4.770974322281625740e-02
0.000000000000000000e+00 -2.546504990237662969e-01 -3.784101243978747753e-02 1.260862922891491933e-01 1.647788601490035587e-01 -1.359350420372563810e-02 -2.106242527925866748e-01 -1.992139115298161289e-01 -6.102643993508066744e-02 1.415736533030401145e-01 -3.720342722134980379e-02 -7.932470758943818701e-02 -1.627263373257165358e-01 -1.575890003658152461e-01 8.565006563414664931e-02 -2.683555868167755154e-01 3.660085956449456446e-01 4.762628414127780818e-01 -1.449575485414473508e-01 -1.934904159674643853e-01 -8.264902193127415808e-02 7.414363430872741856e-02 -1.896304293697095578e-01 -3.955715975713954696e-02 3.342208123316792734e-01 1.405213022145727630e-01 3.982850269061045945e-02 -2.870887921547021771e-02 1.430284662711455990e-01 -1.080380606938250582e-02 -7.474755676228536649e-02 -1.233506793113393479e-01
0.000000000000000000e+00 1.259974834053787518e-01 -4.642223552365133676e-02 -2.731677918868244959e-01 1.401763940683183607e-01 1.758102985690586373e-02 -7.190378833577659723e-02 -2.265002324195051001e-02 -9.381468541456365606e-02 2.475779517881444153e-02 -2.117141053055167019e-02 -3.730919983714339749e-02 6.293254784768963217e-02 8.281084392413905204e-02 -1.515696082102384323e-03 -5.722326393434593039e-02 1.363920664522442483e-01 -2.294498613640584828e-01 1.214375218991275152e-01 2.110996665722856824e-01 -1.462012303503342631e-02 2.201316171282361595e-02 4.213698204201951625e-02 1.510520052931466073e-01 -4.446968766492036262e-02 -6.719951073073199277e-02 5.321625777578230243e-02 -1.911700178216604595e-01 6.199376564757108632e-01 -1.125351571135569106e-01 -2.374972296789227832e-01 -4.486024773698337742e-01
0.000000000000000000e+00 -2.782304034016550021e-01 -1.617431340231197390e-01 2.621220320925329306e-01 2.573424812965595110e-01 -2.093251263578113641e-01 3.287453419404596233e-01 1.816762197614057439e-01 6.917427576339112150e-02 -7.734181713806781433e-02 -1.148785191051222010e-01 -9.075756728416631280e-02 1.207511550864871774e-02 -6.559178746253772896e-02 -4.903625202969286861e-02 -6.093908793932394097e-03 -1.333400118402269241e-01 -7.722694542727318034e-02 -8.537648109788872897e-02 -6.801272582414216727e-02 -2.105025039064028353e-02 1.011484931431730350e-01 1.071805286122596984e-01 -2.509517043643432754e-01 -1.906741223229950488e-01 2.804285215520846974e-01 -8.424087688640249927e-02 1.109332230810501085e-01 2.063416989654872635e-01 -2.054044419275314892e-01 3.467023682122187256e-01 -2.781000170013016026e-01
0.000000000000000000e+00 -1.675936078266815066e-01 -5.988253822668886117e-02 2.913167360951617879e-01 -3.441579597061784623e-01 -2.512399851388172900e-01 -2.016853518719049013e-02 1.073617170629483780e-02 -1.331479566702301609e-01 -9.188557831651325558e-02 9.938403053266109399e-02 4.630325759362260984e-02 -9.916027356301651552e-02 1.299999159128897019e-01 3.997846699673569121e-02 5.871451101542604634e-02 -2.352180192992150143e-01 1.627328191266904159e-02 7.960602433635230457e-02 -2.619619802819314267e-02 -4.135892169763127901e-02 -6.311753801843249245e-02 1.021719454386967874e-01 -1.232084340969226421e-01 3.465389971182153417e-01 -3.703552410396416250e-01 -5.669794891245764912e-02 -1.004557088816182206e-02 4.745372487558510155e-01 5.452325727124463645e-02 4.589116809745708014e-02 2.159631682520395668e-01
9.733163272002616218e-01 -4.668848541554282416e-02 -8.717240884809476786e-02 -8.003287060109429141e-03 -4.235781452365307287e-02 -2.436044451088878807e-02 -7.399358239729543485e-02 3.026427945416049203e-03 -4.735842916905746991e-02 5.259947502657264656e-02 1.219774026885521792e-02 1.959440886450960692e-02 -2.192872832294955748e-02 -6.760253727885437436e-02 -4.601986618919090555e-02 9.549690355568015571e-03 -6.580600226665914154e-02 -6.688264233710168594e-03 8.470705168671467666e-03 -1.589500962257759178e-02 -3.787308253912602396e-02 5.694453060954130647e-02 3.026055839418072962e-03 2.424963863670283673e-02 -5.135563121791192343e-02 -1.235273275637182450e-02 -2.692920869394344052e-02 -4.324463451478151310e-02 -4.254027886286210203e-02 -5.563929169218964632e-02 -3.884440710803919311e-02 -1.910427040380506883e-02
"""
        fd = io.StringIO(V_wm_txt)
        V_wm = np.loadtxt(fd)

        watermark = np.dot(U_wm, np.dot(np.diag(S_extracted), V_wm))
        watermarks.append(watermark)

    return watermarks


def detection(input1, input2, input3):
    """
    input1: original image
    input2: watermarked image
    input3: attacked image
    """
    original_img = cv2.imread(input1, 0)
    watermarked_img = cv2.imread(input2, 0)
    attacked_img = cv2.imread(input3, 0)

    original_watermarks = extraction(watermarked_img, original_img)
    # watermark = np.load("findbrivateknowledge.npy")
    # original_watermarks = [watermark_to_bytes(np.resize(watermark, (32,32))) for i in range(len(original_watermarks))]

    attacked_watermarks = extraction(attacked_img, original_img)

    max_sim = None
    min_sim = None
    for o_w in original_watermarks:
        for a_w in attacked_watermarks:
            act_sim = similarity(np.array(o_w), np.array(a_w))
            if max_sim is None or act_sim > max_sim:
                max_sim = act_sim
                max_or = o_w
                max_at = a_w
            if min_sim is None or act_sim < min_sim:
                min_sim = act_sim

    wpsnr_res = wpsnr(watermarked_img, attacked_img)
    detected = 1 if max_sim > THRESHOLD else 0
    return detected, wpsnr_res


if __name__ == "__main__":
    original_image = 'lena_grey.bmp'
    watermarked_image = 'findbrivateknowledge_embedded.bmp'
    attacked_image = 'results/findbrivateknowledge_attacked0.bmp'

    detected, wpsnr_value = detection(
        original_image, watermarked_image, attacked_image)
    print("Detected:", detected, " with WPSNR:", wpsnr_value)
